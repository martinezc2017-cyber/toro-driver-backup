================================================================================
BUGS Y CORRECCIONES - M√âXICO - DOCUMENTO MAESTRO
================================================================================
Fecha: 30 Enero 2026
Consolidando TODOS los problemas encontrados en m√∫ltiples an√°lisis

================================================================================
SECCI√ìN 1: BUGS CR√çTICOS EN UI/UX
================================================================================

## BUG #1: UNIDADES INCORRECTAS - "Per Mile" en M√©xico ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CR√çTICO
--------------------------------------------------------------------------------
UBICACI√ìN: /admin/pricing cuando country = M√©xico
SCREENSHOT: Se ve claramente "Per Mile $ 8.50"

PROBLEMA:
- Database: columna `per_km` (kil√≥metros)
- UI muestra: "Per Mile" (millas)
- M√©xico usa sistema M√âTRICO (km), no imperial (millas)

IMPACTO FINANCIERO:
- Admin configura $8.50 pensando "por milla"
- Se guarda como $8.50 "por km"
- 1 milla = 1.609 km
- Precio real deber√≠a ser: $8.50 / 1.609 = $5.28 por km
- P√âRDIDA DE REVENUE: ~60% menos ingresos

CAUSA ROOT:
- admin_pricing_screen.dart NO cambia labels seg√∫n pa√≠s
- Hardcoded "Per Mile" en lugar de dynamic "Per ${unit}"

SOLUCI√ìN:
```dart
// En lugar de:
Text('Per Mile')

// Usar:
Text(country.isMexico ? 'Por KM' : 'Per Mile')
```

ARCHIVOS AFECTADOS:
- lib/features/admin/admin_pricing_screen.dart
- Cualquier lugar que muestre distancia

LUGARES A REVISAR:
[ ] Label de input "Per Mile"
[ ] Calculadora - ¬øusa km o millas?
[ ] Finance reports - ¬ømuestra km o millas?
[ ] Ride details - ¬ødistancia en km o millas?
[ ] Driver earnings - ¬øc√°lculo por km o milla?

PRIORIDAD: üî¥ CR√çTICO - Arreglar INMEDIATAMENTE


## BUG #2: Currency Symbol Inconsistency (PENDIENTE VERIFICAR)
--------------------------------------------------------------------------------
UBICACI√ìN: Por determinar

PROBLEMA POTENCIAL:
- ¬øTodos los $ son MXN cuando country = M√©xico?
- ¬øO algunos siguen mostrando USD?

VERIFICAR:
[ ] TARIFAS section - ¬ømuestra $ o MXN?
[ ] Calculadora - ¬øresultado en MXN o USD?
[ ] Finance - ¬ørevenue en MXN o USD?
[ ] Driver payouts - ¬øen MXN o USD?

SOLUCI√ìN:
```dart
Text('${country.currencySymbol} ${amount}')
// MXN: $ o MX$
// USD: $ o US$
```

PRIORIDAD: üü° ALTA


## BUG #3: Language/Localization Incompleto (PENDIENTE VERIFICAR)
--------------------------------------------------------------------------------
UBICACI√ìN: Toda la UI

PROBLEMA POTENCIAL:
- ¬øUI est√° en espa√±ol cuando country = M√©xico?
- ¬øO sigue en ingl√©s?

Screenshot muestra:
- "Per Mile" (ingl√©s)
- "Base Fare" (ingl√©s)
- "Booking Fee" (ingl√©s)
- "Service Fee" (ingl√©s)

Deber√≠a mostrar:
- "Por KM" (espa√±ol)
- "Tarifa Base" (espa√±ol)
- "Cargo de Reserva" (espa√±ol)
- "Cargo de Servicio" (espa√±ol)

VERIFICAR:
[ ] ¬øExiste es-MX.json en admin web?
[ ] ¬øSe activa autom√°ticamente con pa√≠s M√©xico?
[ ] ¬øTodas las secciones est√°n traducidas?

PRIORIDAD: üü° ALTA


================================================================================
SECCI√ìN 2: BUGS DE SCHEMA/DATABASE
================================================================================

## BUG #4: Column Name Inconsistency - state vs state_code
--------------------------------------------------------------------------------
UBICACI√ìN: pricing_zones_mx table

PROBLEMA:
Migration 008 l√≠nea 14 dice en comentario:
    state_code TEXT NOT NULL, -- 'CDMX', 'JAL', 'NL'

Pero los INSERTs usan 'state_code'
Y el c√≥digo tiene que hacer aliasing:
    'state_code': z['state'], // Alias

IMPACTO:
- Confusi√≥n en c√≥digo
- Mantener aliases en m√∫ltiples lugares
- Bugs potenciales

SOLUCI√ìN:
Decidir UN nombre y usarlo consistentemente:
OPCI√ìN A: Renombrar columna a 'state_code'
OPCI√ìN B: Renombrar todos los aliases a 'state'

RECOMENDACI√ìN: Usar 'state' (m√°s simple)

ARCHIVOS AFECTADOS:
- supabase/migrations/008_mexico_pricing.sql
- lib/features/admin/mexico/mexico_pricing_repo.dart (l√≠neas 26-29)

PRIORIDAD: üü° ALTA


## BUG #5: Column Name Aliasing - per_minute vs per_min
--------------------------------------------------------------------------------
UBICACI√ìN: pricing_rules_mx table

PROBLEMA:
Database: per_minute, minimum_fare
C√≥digo UI: per_min, min_fare

mexico_pricing_repo.dart l√≠neas 164-169:
    'per_min': r['per_minute'],
    'min_fare': r['minimum_fare'],

IMPACTO:
- Aliases en m√∫ltiples lugares
- C√≥digo dif√≠cil de mantener

SOLUCI√ìN:
Usar nombres consistentes:
OPCI√ìN A: DB usa per_minute, c√≥digo usa per_minute
OPCI√ìN B: DB renombra a per_min, c√≥digo usa per_min

RECOMENDACI√ìN: Usar nombres completos (per_minute, minimum_fare)

PRIORIDAD: üü° ALTA


## BUG #6: service_type vs vehicle_type Confusion
--------------------------------------------------------------------------------
UBICACI√ìN: pricing_rules_mx table y c√≥digo

PROBLEMA:
mexico_pricing_repo.dart l√≠nea 168:
    'vehicle_type': r['service_type'], // ‚Üê MAL

service_type deber√≠a ser: ride, delivery, carpool
vehicle_type deber√≠a ser: standard, premium, moto

Pero est√°n MEZCLADOS en el mapeo.

IMPACTO:
- No se puede filtrar por tipo de veh√≠culo
- Bugs en matching de reglas

SOLUCI√ìN:
Agregar columna vehicle_type real a pricing_rules_mx
Separar los conceptos completamente

PRIORIDAD: üî¥ CR√çTICO


## BUG #7: Falta country_code en rides/deliveries
--------------------------------------------------------------------------------
UBICACI√ìN: rides, deliveries tables

PROBLEMA:
No hay forma de distinguir rides de USA vs M√©xico

IMPACTO:
- Finance no puede separar revenue USA vs MX
- Analytics no puede comparar m√©tricas
- Reporting fiscal imposible

SOLUCI√ìN:
```sql
ALTER TABLE rides ADD COLUMN country_code TEXT DEFAULT 'US';
ALTER TABLE deliveries ADD COLUMN country_code TEXT DEFAULT 'US';
UPDATE rides SET country_code = 'US' WHERE country_code IS NULL;
```

PRIORIDAD: üî¥ CR√çTICO


================================================================================
SECCI√ìN 3: FEATURES FALTANTES
================================================================================

## FALTA #8: Payment Method Fees (OXXO/SPEI)
--------------------------------------------------------------------------------
PROBLEMA:
Stripe cobra fees diferentes por m√©todo de pago en M√©xico:
- OXXO: ~$10-15 MXN cargo fijo
- SPEI: Gratis pero 24-48hrs
- Tarjeta: 2.9% + $3.00 MXN

Pero pricing NO incluye estos fees.

IMPACTO:
- P√©rdida de margen en pagos OXXO
- Riders confundidos con cargos adicionales

SOLUCI√ìN:
Agregar a pricing_rules_mx:
- oxxo_fee DECIMAL(10,2)
- card_processing_fee_percent DECIMAL(5,2)
- card_processing_fee_fixed DECIMAL(10,2)

PRIORIDAD: üü° ALTA


## FALTA #9: FX Rates Integration
--------------------------------------------------------------------------------
PROBLEMA:
Tabla fx_rates existe
Edge function fx-refresh existe
Pero c√°lculos NO usan FX rates

IMPACTO:
- No se puede cobrar en USD a riders americanos
- No hay conversi√≥n autom√°tica

SOLUCI√ìN:
Integrar FX rates en mexico_pricing_repo._calculateFareLocally()
Guardar fx_rate_used en ride_fares

PRIORIDAD: üü¢ MEDIA (nice to have)


## FALTA #10: Geographic Polygons
--------------------------------------------------------------------------------
PROBLEMA:
Columna 'area' en pricing_zones_mx est√° NULL
No hay validaci√≥n geogr√°fica real

IMPACTO:
- Rider en Puebla podr√≠a obtener pricing de CDMX
- No hay cobertura real definida

SOLUCI√ìN:
Importar pol√≠gonos GeoJSON para cada zona metropolitana
Usar PostGIS ST_Contains para validar

PRIORIDAD: üü¢ MEDIA


================================================================================
SECCI√ìN 4: COBERTURA GEOGR√ÅFICA
================================================================================

## FALTA #11: Solo 15% Cobertura de M√©xico
--------------------------------------------------------------------------------
PROBLEMA:
M√©xico: 32 estados
Configurados: 4-5 estados (CDMX, JAL, NL, BC, QROO)
Cobertura: 12.5% - 15.6%

ZONAS ACTUALES:
1. CDMX - Ciudad de M√©xico
2. Guadalajara - Jalisco
3. Monterrey - Nuevo Le√≥n
4. Tijuana - Baja California
5. Canc√∫n - Quintana Roo

FALTAN TOP 10 CIUDADES:
6. Puebla (3.2M hab)
7. Le√≥n, Guanajuato (1.9M)
8. Ciudad Ju√°rez, Chihuahua (1.5M)
9. Toluca, Estado de M√©xico (2.3M)
10. San Luis Potos√≠ (1.2M)
11. M√©rida, Yucat√°n (1.1M)
12. Quer√©taro (1.0M)
13. Acapulco, Guerrero (0.9M)
14. Aguascalientes (1.0M)
15. Mexicali, Baja California (1.0M)

IMPACTO:
- Solo 27% de poblaci√≥n mexicana cubierta
- Competidores operan en m√°s ciudades

SOLUCI√ìN:
Agregar pricing zones para top 15 ciudades m√≠nimo

PRIORIDAD: üü° ALTA


## FALTA #12: Zonas por Ciudad, No por Estado
--------------------------------------------------------------------------------
PROBLEMA:
Guadalajara configurada, pero ¬øZapopan? ¬øTlaquepaque? ¬øPuerto Vallarta?
Monterrey configurada, pero ¬øSan Pedro? ¬øSanta Catarina?

IMPACTO:
- Riders en √°rea metropolitana extendida no pueden solicitar
- Limita crecimiento

SOLUCI√ìN:
Definir zonas metropolitanas completas
O pricing por estado completo como fallback

PRIORIDAD: üü° ALTA


================================================================================
SECCI√ìN 5: ADMIN UI FALTANTES
================================================================================

## FALTA #13: Admin Mexico Documents Screen
--------------------------------------------------------------------------------
PROP√ìSITO: Gestionar documentos de drivers mexicanos (INE, RFC, Licencia, etc.)

ACTUALMENTE:
- Driver app tiene mexico_documents_screen.dart (driver ve sus docs)
- Admin NO tiene pantalla para gestionar/aprobar

IMPACTO:
- Admin no puede verificar documentos
- No hay workflow de aprobaci√≥n

SOLUCI√ìN:
Crear /admin/mexico/documents con:
- Lista de drivers MX con status docs
- Filtros por estado de verificaci√≥n
- Acciones: Aprobar/Rechazar/Solicitar recarga

PRIORIDAD: üî¥ CR√çTICO


## FALTA #14: Admin Mexico Tax Screen
--------------------------------------------------------------------------------
PROP√ìSITO: Ver retenciones ISR/IVA de TODOS los drivers

ACTUALMENTE:
- Driver app tiene mexico_tax_screen.dart (driver ve sus retenciones)
- Admin NO tiene vista consolidada

IMPACTO:
- No hay control sobre obligaciones fiscales
- No se pueden generar reportes SAT

SOLUCI√ìN:
Crear /admin/mexico/tax con:
- Lista de retenciones por driver
- Res√∫menes mensuales consolidados
- Export para contabilidad

PRIORIDAD: üî¥ CR√çTICO


## FALTA #15: Admin Mexico CFDI Screen
--------------------------------------------------------------------------------
PROP√ìSITO: Gestionar TODAS las facturas CFDI

ACTUALMENTE:
- Rider app tiene mexico_invoice_screen.dart (rider solicita CFDI)
- Admin NO tiene gesti√≥n de facturas

IMPACTO:
- No hay control sobre CFDIs emitidas
- No se pueden cancelar facturas err√≥neas

SOLUCI√ìN:
Crear /admin/mexico/cfdi con:
- Lista de CFDIs generadas
- Filtros por status/tipo/usuario
- Acciones: Ver XML/PDF, Cancelar, Regenerar

PRIORIDAD: üî¥ CR√çTICO


## FALTA #16: Admin Mexico Analytics
--------------------------------------------------------------------------------
PROP√ìSITO: KPIs espec√≠ficos de operaci√≥n M√©xico

FALTA:
- Dashboard separado para M√©xico
- Comparativa USA vs MX
- M√©tricas de m√©todos de pago (OXXO/SPEI)

SOLUCI√ìN:
Agregar tab M√©xico en Analytics o screen separado

PRIORIDAD: üü° ALTA


## FALTA #17: Admin Mexico Compliance
--------------------------------------------------------------------------------
PROP√ìSITO: Cumplimiento legal M√©xico (SEMOVI, TNC licenses por estado)

FALTA:
- Monitor de licencias estatales
- Requisitos por estado mexicano

SOLUCI√ìN:
Crear /admin/mexico/compliance similar a USA compliance

PRIORIDAD: üü° ALTA


================================================================================
SECCI√ìN 6: ADMIN UI - DROPDOWN HARDCODEADO
================================================================================

## BUG #18: Estados Hardcodeados en Dropdown
--------------------------------------------------------------------------------
UBICACI√ìN: admin_mexico_pricing_screen.dart l√≠nea 1063-1069

PROBLEMA:
```dart
items: const [
    DropdownMenuItem(value: 'CDMX', child: Text('CDMX')),
    DropdownMenuItem(value: 'JAL', child: Text('Jalisco')),
    DropdownMenuItem(value: 'NL', child: Text('Nuevo Leon')),
    DropdownMenuItem(value: 'GTO', child: Text('Guanajuato')),
    DropdownMenuItem(value: 'QRO', child: Text('Queretaro')),
],
```

Solo 5 estados hardcodeados.

IMPACTO:
- No se pueden agregar nuevos estados desde UI
- Hay que editar c√≥digo para agregar estados

SOLUCI√ìN:
Cargar din√°micamente desde tabla mexican_states

PRIORIDAD: üü° ALTA


================================================================================
SECCI√ìN 7: DATOS DE PRUEBA VS PRODUCCI√ìN
================================================================================

## PREGUNTA #19: Pricing Valores Reales?
--------------------------------------------------------------------------------
VALORES ACTUALES:
- CDMX: Base $35, /km $8.50, /min $2.50
- Guadalajara: Base $30, /km $7.50
- Monterrey: Base $32, /km $8.00

PREGUNTAS:
- ¬øSon precios de producci√≥n o placeholders?
- ¬øCompetitivos vs Uber/Didi?
- ¬øCubren costos operacionales?

ACCI√ìN:
Validar pricing con:
- Estudio de mercado competidores
- An√°lisis de costos operacionales MX
- Willingness to pay usuarios

PRIORIDAD: üü° ALTA


================================================================================
SECCI√ìN 8: INTEGRACI√ìN EN PANELES EXISTENTES
================================================================================

## FALTA #20: Finance - Filtro de Pa√≠s
--------------------------------------------------------------------------------
PROBLEMA:
Finance panels (Overview, Transactions, Payouts) NO tienen filtro USA/MX

IMPACTO:
- No se puede separar revenue USA vs MX
- Reporting fiscal mezclado

SOLUCI√ìN:
Agregar selector de pa√≠s en:
- finance_overview_screen.dart
- transactions_screen.dart
- driver_payouts_screen.dart

PRIORIDAD: üî¥ CR√çTICO


## FALTA #21: Calendar - Eventos Fiscales M√©xico
--------------------------------------------------------------------------------
PROBLEMA:
Calendar NO muestra eventos de retenciones mensuales MX

SOLUCI√ìN:
Integrar eventos de tax_monthly_summary en calendar

PRIORIDAD: üü¢ BAJA


## FALTA #22: Map - Distinguir Drivers USA vs MX
--------------------------------------------------------------------------------
PROBLEMA:
Mapa muestra todos los drivers igual

SOLUCI√ìN:
Marcadores diferentes (üá∫üá∏ vs üá≤üáΩ)
Filtro: USA only / MX only / Both

PRIORIDAD: üü¢ BAJA


================================================================================
SECCI√ìN 9: LAS 11 SECCIONES - ¬øFUNCIONAN PARA M√âXICO?
================================================================================

PREGUNTA PENDIENTE:
El screenshot muestra 11 secciones, pero ¬øtodas est√°n ACTIVAS para M√©xico?

SECCIONES:
1. TARIFAS (6) - ‚úÖ Confirmado funciona (se ve en screenshot)
2. TIEMPO (7) - ‚ùì ¬øFunciona para MX?
3. MULTIPLICADORES (9) - ‚ùì ¬øFunciona para MX?
4. SERVICIOS (6) - ‚ùì ¬øFunciona para MX?
5. CANCELACIONES (6) - ‚ùì ¬øFunciona para MX?
6. LOST ITEMS (3) - ‚ùì ¬øFunciona para MX?
7. ZONAS (4) - ‚úÖ Confirmado funciona (carga de pricing_zones_mx)
8. QR POINTS (3) - ‚ùì ¬øFunciona para MX?
9. CARPOOL (4) - ‚ùì ¬øFunciona para MX?
10. LIMPIEZA (3) - ‚ùì ¬øFunciona para MX?
11. DA√ëOS (4) - ‚ùì ¬øFunciona para MX?

PREGUNTA AL USUARIO:
¬øTodas las secciones 2-11 guardan datos espec√≠ficos para M√©xico?
¬øO solo se ven pero no hacen nada diferente de USA?


================================================================================
RESUMEN EJECUTIVO
================================================================================

TOTAL BUGS/ISSUES ENCONTRADOS: 22

BUGS CR√çTICOS (arreglar YA): 7
- BUG #1: Per Mile en lugar de Per KM
- BUG #6: service_type vs vehicle_type
- BUG #7: Falta country_code en rides
- FALTA #13: Admin Mexico Documents Screen
- FALTA #14: Admin Mexico Tax Screen
- FALTA #15: Admin Mexico CFDI Screen
- FALTA #20: Finance filtro de pa√≠s

BUGS ALTA PRIORIDAD: 9
- BUG #2: Currency symbols
- BUG #3: Localization
- BUG #4: state vs state_code
- BUG #5: per_minute vs per_min
- FALTA #8: Payment method fees
- FALTA #11: Cobertura geogr√°fica
- FALTA #12: Zonas metropolitanas
- FALTA #16: Mexico Analytics
- BUG #18: Dropdown hardcodeado

BUGS MEDIA/BAJA PRIORIDAD: 6
- FALTA #9: FX rates
- FALTA #10: Geographic polygons
- FALTA #17: Mexico compliance
- PREGUNTA #19: Pricing valores
- FALTA #21: Calendar eventos
- FALTA #22: Map filtros


================================================================================
PR√ìXIMOS PASOS
================================================================================

FASE 1 - FIXES CR√çTICOS (Sesi√≥n 1):
[ ] BUG #1: Cambiar "Per Mile" ‚Üí "Por KM" cuando country = MX
[ ] BUG #6: Separar service_type y vehicle_type
[ ] BUG #7: Agregar country_code a rides/deliveries
[ ] FALTA #20: Finance con filtro de pa√≠s

FASE 2 - ADMIN SCREENS (Sesi√≥n 2-3):
[ ] FALTA #13: Crear Admin Mexico Documents Screen
[ ] FALTA #14: Crear Admin Mexico Tax Screen
[ ] FALTA #15: Crear Admin Mexico CFDI Screen
[ ] FALTA #16: Crear Admin Mexico Analytics

FASE 3 - SCHEMA CLEANUP (Sesi√≥n 4):
[ ] BUG #4: Unificar state/state_code
[ ] BUG #5: Unificar per_minute/per_min
[ ] BUG #18: Dropdown din√°mico desde mexican_states

FASE 4 - FEATURES (Sesi√≥n 5+):
[ ] FALTA #8: Payment method fees
[ ] FALTA #11-12: Expansi√≥n geogr√°fica
[ ] FALTA #9: FX rates integration


================================================================================
FIN DEL DOCUMENTO MAESTRO
√öltima actualizaci√≥n: 30 Enero 2026
================================================================================
