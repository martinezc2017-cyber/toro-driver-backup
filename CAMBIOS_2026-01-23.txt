================================================================================
CAMBIOS REALIZADOS - 23 de Enero 2026
TORO DRIVER APP
================================================================================

## 1. FIX: Status Mapping en ride_service.dart
--------------------------------------------------------------------------------
PROBLEMA: Se usaba `RideStatus.xxx.name` que generaba valores incorrectos:
- `RideStatus.arrivedAtPickup.name` → 'arrivedAtPickup' (DB espera 'in_progress')
- `RideStatus.inProgress.name` → 'inProgress' (DB espera 'in_progress')

SOLUCIÓN: Cambié todas las referencias para usar `statusToDatabase()`:
- Línea 36: getPendingRides
- Línea 103, 107: acceptRide
- Línea 288: completeRide
- Línea 331: cancelRide
- Línea 349-352: getActiveRide (CRÍTICO - no encontraba rides activos)
- Línea 377: getRideHistory
- Línea 666: getTodayCompletedRides

ARCHIVO: lib/src/services/ride_service.dart


## 2. FIX: Stripe Payment Capture
--------------------------------------------------------------------------------
PROBLEMA: Cuando el driver completaba un viaje, el pago de Stripe NUNCA se
capturaba. El pre-auth expiraba después de 7 días sin cobrar al rider.

SOLUCIÓN: Agregué llamada a Edge Function `stripe-capture-payment`:

ARCHIVO: lib/src/services/ride_service.dart
- Nueva función `_captureStripePayment()` (líneas 343-401)
- Se llama automáticamente en `completeRide()` después de actualizar DB
- Parámetros: paymentIntentId, amount, tip, stateCode, etc.
- Manejo de errores silencioso (no falla el viaje si Stripe falla)

ARCHIVO: lib/src/models/ride_model.dart
- Agregado campo `stripePaymentIntentId`
- En clase, constructor, fromJson, toJson, copyWith


## 3. FEATURE: Turn-by-Turn Navigation Banner
--------------------------------------------------------------------------------
PROBLEMA: La navegación del driver no mostraba las instrucciones de giro
(next turn) como Uber/Google Maps.

SOLUCIÓN: Agregué banner de navegación turn-by-turn:

ARCHIVO: lib/src/screens/home_screen.dart

Variables nuevas (línea ~2938):
- `_navigationSteps` - Lista de pasos de navegación
- `_currentStepIndex` - Índice del paso actual
- `_currentStep` / `_nextStep` - Getters para acceso rápido

Funciones nuevas:
- `_updateCurrentNavigationStep()` - Actualiza paso cuando driver se acerca
- `_buildNavigationBanner()` - Widget del banner con:
  * Icono de maniobra (giro izq/der, recto, rotonda, etc.)
  * Distancia hasta la maniobra (ej: "500m")
  * Instrucción de texto (ej: "Gira a la derecha en Main St")

Integración:
- Banner posicionado en parte superior del mapa 3D (línea ~4311)
- Steps se guardan cuando se obtiene ruta de Mapbox (línea ~3313)
- Step se actualiza con cada cambio de ubicación GPS (línea ~3240)
- Reset automático al iniciar viaje o cambiar de pickup a destino


## 4. FIX: Claude Crash en Toro Rider
--------------------------------------------------------------------------------
PROBLEMA: Claude Code crasheaba en el proyecto toro rider por archivos muy grandes.

SOLUCIÓN:
- Renombré CLAUDE.md (134KB) → CLAUDE_HISTORICO.md
- Creé nuevo CLAUDE.md pequeño (~500 bytes)
- Moví archivos de .claude/ a .claude/_old/:
  * context.md
  * PRICING_SYSTEM.md
  * TORO_FINANCIAL_FLOW.md
  * REGLAS_CRITICAS.md
- Moví .md de lib/features/admin/ a docs/:
  * ADMIN_DATA_SOURCES.md
  * ADMIN_FINANCE_CONTRACT.md
  * AUDITORIA_ADMIN_WEB_2026_01_22.md


## 5. FEATURE: Soporte para Carpools (share_ride_bookings)
--------------------------------------------------------------------------------
PROBLEMA: El driver solo veía rides de la tabla `deliveries`, pero los carpools
están en `share_ride_bookings`. No podía ver ni aceptar carpools.

SOLUCIÓN: Modificado ride_service.dart para buscar en AMBAS tablas:

ARCHIVO: lib/src/services/ride_service.dart
- `getAvailableRides()` - Ahora busca en deliveries + share_ride_bookings
- `getRide()` - Busca primero en deliveries, si no encuentra busca en carpools
- `acceptRide()` - Detecta si es carpool y actualiza tabla correcta
- `completeRide()` - Detecta si es carpool y actualiza tabla correcta

ARCHIVO: lib/src/models/ride_model.dart
- Agregado soporte para campos de carpools:
  * `origin_lat` / `origin_lng` (alias de pickup_lat/lng)
  * `rider_id` (alias de user_id)
  * `distance_miles`
- Cambiado default de `parseServiceType()` de `package` a `passenger`


## 6. FIX: Mapa Negro y Mapa Fantasma al Aceptar/Cancelar
--------------------------------------------------------------------------------
PROBLEMA: Al aceptar un viaje, el mapa se ponía negro. Al cancelar, aparecía
un mapa 2D fantasma con las rutas del viaje anterior.

CAUSA:
- No se limpiaba el estado de Mapbox cuando el ride cambiaba
- No había `didUpdateWidget` para detectar cambios de ride
- El widget no se reconstruía completamente al cambiar de ride

SOLUCIÓN:

ARCHIVO: lib/src/screens/home_screen.dart

1. Nuevo método `_cleanupMapboxResources()` (línea ~5201):
   - Limpia `_polylineManager`, `_pointManager`
   - Reset de `_mapboxMap`, `_mapboxRouteGeometry`, `_routePoints`
   - Reset de `_navigationSteps`

2. `dispose()` ahora llama a `_cleanupMapboxResources()` (línea ~5195)

3. Nuevo `didUpdateWidget()` (línea ~3051):
   - Detecta cuando ride cambia (hadRide → hasRide, o rideId diferente)
   - Limpia estado del mapa anterior
   - Reset de navigation state y screen positions
   - Obtiene nueva ruta si hay nuevo ride

4. ValueKey en widget (línea ~305):
   - `key: ValueKey('nav_${rideId ?? 'idle'}')`
   - Fuerza rebuild completo cuando el ride cambia

5. `_ActiveRideNavigation` ahora acepta `super.key` (línea ~2894)


================================================================================
ARCHIVOS MODIFICADOS
================================================================================
1. lib/src/services/ride_service.dart - Status mapping + Stripe capture + Carpools
2. lib/src/models/ride_model.dart - stripePaymentIntentId + campos carpool
3. lib/src/screens/home_screen.dart - Turn-by-turn + Fix mapa negro/fantasma

================================================================================
ARCHIVOS EN TORO RIDER (limpieza)
================================================================================
- CLAUDE.md (nuevo, pequeño)
- CLAUDE_HISTORICO.md (renombrado)
- .claude/_old/* (archivos movidos)
- docs/*.md (archivos movidos de lib/)

================================================================================
