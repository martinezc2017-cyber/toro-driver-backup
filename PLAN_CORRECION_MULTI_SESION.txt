================================================================================
PLAN DE CORRECCIÓN - MÚLTIPLES SESIONES
TORO DRIVER APP - SOPORTE MÉXICO
================================================================================
Fecha: 30 Enero 2026
Propósito: Investigar, corregir e implementar soporte completo para México
Advertencia: NO HACER CAMBIOS SIN INVESTIGAR PRIMERO

================================================================================
ESTADO ACTUAL DEL PROYECTO (INVESTIGACIÓN COMPLETADA)
================================================================================

## 1. ARCHIVOS FLUTTER YA IMPLEMENTADOS (UNTRACKED EN GIT)
--------------------------------------------------------------------------------
✅ lib/src/services/mexico_documents_service.dart (382 líneas)
   - Manejo de documentos mexicanos: INE, RFC, Licencia E1, Tarjetón, Seguro ERT
   - Validación y tracking de expiración
   - PENDIENTE: Verificar integración con Supabase

✅ lib/src/services/mexico_tax_service.dart (322 líneas)
   - Cálculo de retenciones ISR/IVA
   - ISR: 2.5% con RFC, 20% sin RFC
   - IVA: 8%
   - PENDIENTE: Verificar que funcione con edge functions

✅ lib/src/services/mexico_pricing_service.dart (444 líneas)
   - Cotización de viajes para zonas mexicanas
   - Pricing basado en zonas con multiplicadores noche/fin de semana
   - Soporte para conversión FX
   - PENDIENTE: Verificar integración con pricing_zones_mx

✅ lib/src/services/mexico_cfdi_service.dart (304 líneas)
   - Generación de facturas CFDI 4.0
   - Integración con PAC (Facturama/SW Sapien)
   - PENDIENTE: Verificar conexión con edge function generate-cfdi

✅ lib/src/screens/mexico_documents_screen.dart (598 líneas)
   - UI para subir documentos mexicanos
   - Barra de progreso, alertas de expiración
   - PENDIENTE: Verificar navegación desde profile_screen

✅ lib/src/screens/mexico_tax_screen.dart (563 líneas)
   - Muestra RFC, tasas de impuestos, resúmenes mensuales
   - Descarga de certificados de retención
   - PENDIENTE: Verificar integración con datos reales

✅ lib/src/screens/mexico_invoices_screen.dart (727 líneas)
   - Historial de facturas CFDI
   - Descarga XML/PDF, solicitud de nuevas facturas
   - PENDIENTE: Verificar funcionalidad completa

✅ assets/lang/es-MX.json
   - 800+ strings de localización en español mexicano
   - PENDIENTE: Integrar con Easy Localization


## 2. SQL MIGRATIONS YA CREADAS (UNTRACKED EN GIT)
--------------------------------------------------------------------------------
✅ supabase/migrations/004_mexico_countries.sql (274 líneas)
   - Tablas: countries, mexican_states, fx_rates
   - PENDIENTE: Aplicar a Supabase

✅ supabase/migrations/005_mexico_documents.sql
   - Tabla: driver_documents_mx
   - PENDIENTE: Aplicar a Supabase

✅ supabase/migrations/006_mexico_tax_retentions.sql
   - Tablas: tax_retentions, tax_monthly_summary
   - PENDIENTE: Aplicar a Supabase

✅ supabase/migrations/007_mexico_cfdi.sql
   - Tablas: cfdi_invoices, cfdi_platform_config, catálogos CFDI
   - PENDIENTE: Aplicar a Supabase

✅ supabase/migrations/008_mexico_pricing.sql
   - Tablas: pricing_zones_mx, pricing_rules_mx, ride_fares
   - PENDIENTE: Aplicar a Supabase

✅ supabase/migrations/009_multi_stripe_mexico.sql
   - Soporte multi-provider Stripe (US + MX)
   - PENDIENTE: Aplicar a Supabase


## 3. EDGE FUNCTIONS YA IMPLEMENTADAS
--------------------------------------------------------------------------------
✅ supabase/functions/pricing-quote-mx/
   - Calcula cotizaciones para México
   - PENDIENTE: Verificar deployment

✅ supabase/functions/fx-refresh/
   - Actualiza tasas de cambio
   - PENDIENTE: Verificar deployment y scheduler

✅ supabase/functions/calculate-tax-retention/
   - Calcula retenciones ISR/IVA
   - PENDIENTE: Verificar deployment

✅ supabase/functions/generate-cfdi/
   - Genera facturas CFDI con mock de Facturama
   - PENDIENTE: Verificar deployment y configuración PAC

✅ supabase/functions/validate-driver-mx/
   - Valida documentos de drivers mexicanos
   - PENDIENTE: Verificar deployment


## 4. CAMBIOS RECIENTES (23 ENERO 2026)
--------------------------------------------------------------------------------
✅ FIX: Status mapping en ride_service.dart
   - Corregido uso de statusToDatabase()
   - Afectaba: getPendingRides, acceptRide, completeRide, etc.

✅ FIX: Stripe Payment Capture
   - Agregada función _captureStripePayment()
   - Llama a edge function stripe-capture-payment
   - Agregado campo stripePaymentIntentId en RideModel

✅ FEATURE: Turn-by-Turn Navigation Banner
   - Banner con instrucciones de giro
   - Iconos de maniobra, distancia, texto de instrucción

✅ FIX: Claude Crash en Toro Rider
   - Renombrado CLAUDE.md → CLAUDE_HISTORICO.md
   - Movidos archivos grandes a _old/

✅ FEATURE: Soporte para Carpools
   - ride_service.dart busca en deliveries + share_ride_bookings
   - Campos adicionales en RideModel

✅ FIX: Mapa Negro y Mapa Fantasma
   - Nuevo _cleanupMapboxResources()
   - didUpdateWidget() detecta cambios de ride
   - ValueKey para rebuild completo


## 5. CAMBIOS ANTERIORES (03 ENERO 2026)
--------------------------------------------------------------------------------
✅ Stripe Connect para pagos a drivers
   - stripe_connect_service.dart
   - bank_account_screen.dart
   - Ruta /bank-account

✅ Rankings en estadísticas
   - Campos: stateRank, usaRank, state en DriverModel
   - Profile screen muestra rankings

✅ Borde cyan en login
   - Login screen con borde #00D9FF


## 6. STRIPE CONFIG ACTUAL
--------------------------------------------------------------------------------
✅ lib/src/config/stripe_config.dart
   - Enum StripeProvider {us, mx}
   - Dos publishable keys configuradas (modo testing)
   - Métodos: initializeWithProvider(), switchProvider(), detectProviderFromLocation()
   - PENDIENTE: Verificar que switchProvider() funcione correctamente


================================================================================
PROBLEMAS IDENTIFICADOS (LO QUE ESTÁ ROTO)
================================================================================

## CRÍTICO 1: Archivos no rastreados en Git
--------------------------------------------------------------------------------
PROBLEMA:
- Todos los archivos de México están untracked
- Si se pierde el código, se pierde todo el trabajo
- 13 archivos nuevos sin commit

SOLUCIÓN:
1. Hacer git add de todos los archivos México
2. Crear commit descriptivo
3. IMPORTANTE: NO hacer push sin autorización del usuario


## CRÍTICO 2: Migrations no aplicadas
--------------------------------------------------------------------------------
PROBLEMA:
- 6 migrations creadas pero no aplicadas a Supabase
- Base de datos NO tiene las tablas mexicanas
- Los servicios Flutter fallarán al intentar leer/escribir

SOLUCIÓN:
1. Verificar conexión a Supabase
2. Aplicar migrations en orden: 004 → 005 → 006 → 007 → 008 → 009
3. Verificar que las tablas se crearon correctamente


## CRÍTICO 3: Edge Functions no deployadas
--------------------------------------------------------------------------------
PROBLEMA:
- 5 edge functions creadas pero posiblemente no deployadas
- Sin deployment, los servicios Flutter no pueden llamarlas

SOLUCIÓN:
1. Verificar deployment: supabase functions list
2. Deploy faltantes: supabase functions deploy <nombre>
3. Verificar logs: supabase functions logs <nombre>


## ALTO 4: Localización es-MX no integrada
--------------------------------------------------------------------------------
PROBLEMA:
- es-MX.json creado pero no integrado con Easy Localization
- La app no cambiará a español mexicano

SOLUCIÓN:
1. Verificar pubspec.yaml tiene easy_localization
2. Agregar es-MX a supportedLocales en main.dart
3. Verificar path en assetLoader


## ALTO 5: Rutas de navegación no agregadas
--------------------------------------------------------------------------------
PROBLEMA:
- Screens de México creadas pero no hay rutas en app_router.dart
- No se puede navegar a las pantallas

SOLUCIÓN:
1. Agregar rutas en lib/core/router/app_router.dart:
   - /mexico-documents → MexicoDocumentsScreen
   - /mexico-tax → MexicoTaxScreen
   - /mexico-invoices → MexicoInvoicesScreen
2. Agregar opciones en profile_screen.dart para acceder


## MEDIO 6: Configuración Stripe MX incompleta
--------------------------------------------------------------------------------
PROBLEMA:
- StripeConfig tiene enum pero no claves reales para México
- Falta verificar que switchProvider() funcione

SOLUCIÓN:
1. PREGUNTAR AL USUARIO: ¿Ya tiene cuenta Stripe México?
2. Obtener publishable key y secret key para MX
3. Configurar webhook endpoints para MX
4. Probar switchProvider() con datos reales


## MEDIO 7: Integración PAC para CFDI
--------------------------------------------------------------------------------
PROBLEMA:
- generate-cfdi tiene mock de Facturama
- No hay credenciales reales de PAC

SOLUCIÓN:
1. PREGUNTAR AL USUARIO: ¿Qué PAC usar? (Facturama, SW Sapien, otro)
2. Obtener credenciales de producción
3. Reemplazar mock por integración real
4. Probar generación de CFDI de prueba


## BAJO 8: Verificación de documentos mexicanos
--------------------------------------------------------------------------------
PROBLEMA:
- validate-driver-mx existe pero posiblemente no tiene lógica de validación real

SOLUCIÓN:
1. Verificar qué validaciones se requieren (INE, RFC, etc.)
2. Implementar validaciones reales o integración con APIs externas
3. Probar flujo completo de validación


================================================================================
PLAN DE ACCIÓN - SESIÓN 1 (ESTA SESIÓN)
================================================================================

## OBJETIVO: Asegurar el código y verificar estado de Supabase

FASE 1: Git Commit (5 min)
---------------------------
[ ] git add de archivos México
[ ] Crear commit descriptivo
[ ] Verificar git status


FASE 2: Verificar Supabase (10 min)
------------------------------------
[ ] Verificar conexión a Supabase
[ ] Listar migrations aplicadas
[ ] Listar edge functions deployadas
[ ] Documentar qué falta


FASE 3: Aplicar Migrations (15 min)
------------------------------------
[ ] Aplicar 004_mexico_countries.sql
[ ] Aplicar 005_mexico_documents.sql
[ ] Aplicar 006_mexico_tax_retentions.sql
[ ] Aplicar 007_mexico_cfdi.sql
[ ] Aplicar 008_mexico_pricing.sql
[ ] Aplicar 009_multi_stripe_mexico.sql
[ ] Verificar tablas creadas


FASE 4: Deploy Edge Functions (10 min)
---------------------------------------
[ ] Deploy pricing-quote-mx
[ ] Deploy fx-refresh
[ ] Deploy calculate-tax-retention
[ ] Deploy generate-cfdi
[ ] Deploy validate-driver-mx
[ ] Verificar logs


FASE 5: Actualizar Documentación (5 min)
-----------------------------------------
[ ] Actualizar este plan con resultados
[ ] Crear SESION_1_RESULTADOS.txt


================================================================================
PLAN DE ACCIÓN - SESIÓN 2 (FUTURA)
================================================================================

OBJETIVO: Integrar navegación y localización

[ ] Agregar rutas en app_router.dart
[ ] Integrar es-MX con Easy Localization
[ ] Agregar botones en profile_screen.dart
[ ] Probar navegación completa


================================================================================
PLAN DE ACCIÓN - SESIÓN 3 (FUTURA)
================================================================================

OBJETIVO: Configurar Stripe México y PAC

[ ] Obtener credenciales Stripe MX del usuario
[ ] Configurar webhooks Stripe MX
[ ] Obtener credenciales PAC del usuario
[ ] Integrar PAC real en generate-cfdi
[ ] Probar flujo completo de pago


================================================================================
PLAN DE ACCIÓN - SESIÓN 4 (FUTURA)
================================================================================

OBJETIVO: Pruebas end-to-end

[ ] Probar registro de driver mexicano
[ ] Probar subida de documentos
[ ] Probar cotización de viaje en México
[ ] Probar generación de CFDI
[ ] Probar retenciones de impuestos
[ ] Probar cambio de FX rates


================================================================================
PREGUNTAS PARA EL USUARIO (ANTES DE CONTINUAR)
================================================================================

1. ¿Puedo hacer git commit de los archivos México? (NO haré push sin tu permiso)

2. ¿Tienes acceso a Supabase? ¿Cuál es el proyecto ID?

3. ¿Ya tienes cuenta Stripe para México? ¿O usarás la misma de USA?

4. ¿Qué PAC quieres usar para CFDI? (Facturama, SW Sapien, otro)

5. ¿Quieres que aplique las migrations ahora o prefieres revisarlas primero?


================================================================================
REGLAS CRÍTICAS PARA TODAS LAS SESIONES
================================================================================

❌ NUNCA: Hacer cambios sin investigar primero
❌ NUNCA: Asumir que algo funciona sin probarlo
❌ NUNCA: Hacer push a remote sin autorización
❌ NUNCA: Borrar o sobrescribir código existente sin backup
❌ NUNCA: Aplicar migrations en producción sin backup

✅ SIEMPRE: Leer este plan al inicio de cada sesión
✅ SIEMPRE: Actualizar este plan con resultados
✅ SIEMPRE: Preguntar antes de acciones destructivas
✅ SIEMPRE: Documentar qué se hizo y qué falta
✅ SIEMPRE: Probar antes de marcar como completo


================================================================================
ESTADO DE ARCHIVOS (GIT STATUS ACTUAL)
================================================================================

Modified (tracked):
- .claude/settings.local.json
- lib/main.dart
- lib/src/config/stripe_config.dart
- lib/src/screens/profile_screen.dart
- lib/src/services/geocoding_service.dart
- lib/src/services/services.dart
- lib/src/services/stripe_connect_service.dart
- lib/src/utils/app_colors.dart
- supabase/.temp/cli-latest

Untracked (nuevos):
- .vscode/settings.json
- ANALISIS_MX_3_APPS.txt
- PLAN_MX_COMPLETO.txt
- PLAN_SIGUIENTE_CLAUDE.txt
- assets/lang/es-MX.json
- lib/src/screens/mexico_documents_screen.dart
- lib/src/screens/mexico_invoices_screen.dart
- lib/src/screens/mexico_tax_screen.dart
- lib/src/services/mexico_cfdi_service.dart
- lib/src/services/mexico_documents_service.dart
- lib/src/services/mexico_pricing_service.dart
- lib/src/services/mexico_tax_service.dart
- supabase/functions/ (todos los edge functions)
- supabase/migrations/004_mexico_countries.sql
- supabase/migrations/005_mexico_documents.sql
- supabase/migrations/006_mexico_tax_retentions.sql
- supabase/migrations/007_mexico_cfdi.sql
- supabase/migrations/008_mexico_pricing.sql
- supabase/migrations/009_multi_stripe_mexico.sql


================================================================================
FIN DEL PLAN DE CORRECCIÓN
================================================================================
Última actualización: 30 Enero 2026
Próxima acción: Esperar instrucciones del usuario
