================================================================================
PLAN DE IMPLEMENTACI√ìN COMPLETO - M√âXICO
PARA EL PR√ìXIMO CLAUDE
================================================================================
Fecha: 30 Enero 2026
Este documento contiene TODO lo necesario para implementar soporte M√©xico

IMPORTANTE: Leer BUGS_Y_CORRECCIONES_MEXICO_MASTER.txt primero para contexto.

================================================================================
RESUMEN EJECUTIVO
================================================================================

PROBLEMA:
El admin web tiene soporte para M√©xico pero est√° ROTO:
- Muestra "Per Mile" cuando M√©xico usa kil√≥metros
- Muestra datos de USA cuando el pa√≠s es M√©xico
- No filtra por country_code
- 22 bugs cr√≠ticos documentados

SOLUCI√ìN ACORDADA:
‚úÖ HIDE/SHOW con country switch (NO duplicar c√≥digo)
‚úÖ Agregar country_code a todas las tablas
‚úÖ Filtrar queries por pa√≠s
‚úÖ Labels y unidades din√°micas
‚úÖ Migraci√≥n segura sin romper USA

ESTRATEGIA:
Mantener UN solo codebase, usar adminCountryProvider para mostrar/ocultar
y adaptar comportamiento seg√∫n pa√≠s seleccionado.


================================================================================
FASE 1: DATABASE - AGREGAR COUNTRY_CODE (NO ROMPE NADA)
================================================================================

## PASO 1.1: Crear Migration
--------------------------------------------------------------------------------
ARCHIVO: supabase/migrations/010_add_country_code.sql

```sql
-- ============================================================================
-- MIGRATION 010: Add country_code to all tables
-- ============================================================================

-- Rides
ALTER TABLE public.rides
ADD COLUMN IF NOT EXISTS country_code TEXT DEFAULT 'US';

CREATE INDEX IF NOT EXISTS idx_rides_country
ON public.rides(country_code);

-- Deliveries
ALTER TABLE public.deliveries
ADD COLUMN IF NOT EXISTS country_code TEXT DEFAULT 'US';

CREATE INDEX IF NOT EXISTS idx_deliveries_country
ON public.deliveries(country_code);

-- Drivers
ALTER TABLE public.drivers
ADD COLUMN IF NOT EXISTS country_code TEXT DEFAULT 'US';

CREATE INDEX IF NOT EXISTS idx_drivers_country
ON public.drivers(country_code);

-- Profiles (riders)
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS country_code TEXT DEFAULT 'US';

CREATE INDEX IF NOT EXISTS idx_profiles_country
ON public.profiles(country_code);

-- Support tickets
ALTER TABLE public.support_tickets
ADD COLUMN IF NOT EXISTS country_code TEXT DEFAULT 'US';

-- Transactions (si existe)
DO $$
BEGIN
  IF EXISTS (SELECT FROM pg_tables WHERE tablename = 'transactions') THEN
    ALTER TABLE public.transactions
    ADD COLUMN IF NOT EXISTS country_code TEXT DEFAULT 'US';
  END IF;
END $$;

-- Update existing data to 'US'
UPDATE public.rides SET country_code = 'US' WHERE country_code IS NULL;
UPDATE public.deliveries SET country_code = 'US' WHERE country_code IS NULL;
UPDATE public.drivers SET country_code = 'US' WHERE country_code IS NULL;
UPDATE public.profiles SET country_code = 'US' WHERE country_code IS NULL;

-- RLS policies update (ejemplo para rides)
DROP POLICY IF EXISTS "Drivers can view relevant rides" ON public.rides;
CREATE POLICY "Drivers can view relevant rides" ON public.rides
  FOR SELECT USING (
    driver_id = auth.uid()
  );

-- Comentario importante
COMMENT ON COLUMN public.rides.country_code IS 'Country code: US, MX, etc.';
```

## PASO 1.2: Aplicar Migration
--------------------------------------------------------------------------------
```bash
cd supabase
supabase db push
```

VERIFICAR:
```sql
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'rides' AND column_name = 'country_code';
```

RESULTADO ESPERADO:
- Columna country_code existe
- Default 'US'
- Todos los registros existentes = 'US'
- No se rompe nada


================================================================================
FASE 2: FLUTTER - CREAR COUNTRY HELPER CLASS
================================================================================

## PASO 2.1: Crear Country Model
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/models/admin_country.dart

```dart
/// Country model for admin multi-country support
class AdminCountry {
  final String code;        // 'US', 'MX'
  final String name;        // 'United States', 'M√©xico'
  final String flag;        // 'üá∫üá∏', 'üá≤üáΩ'
  final String currency;    // 'USD', 'MXN'
  final String currencySymbol; // '$', '$'
  final String distanceUnit; // 'mi', 'km'
  final String distanceUnitLong; // 'Miles', 'Kil√≥metros'
  final bool usesMetric;    // false, true

  const AdminCountry({
    required this.code,
    required this.name,
    required this.flag,
    required this.currency,
    required this.currencySymbol,
    required this.distanceUnit,
    required this.distanceUnitLong,
    required this.usesMetric,
  });

  bool get isUSA => code == 'US';
  bool get isMexico => code == 'MX';

  // Predefined countries
  static const usa = AdminCountry(
    code: 'US',
    name: 'United States',
    flag: 'üá∫üá∏',
    currency: 'USD',
    currencySymbol: '\$',
    distanceUnit: 'mi',
    distanceUnitLong: 'Miles',
    usesMetric: false,
  );

  static const mexico = AdminCountry(
    code: 'MX',
    name: 'M√©xico',
    flag: 'üá≤üáΩ',
    currency: 'MXN',
    currencySymbol: '\$',
    distanceUnit: 'km',
    distanceUnitLong: 'Kil√≥metros',
    usesMetric: true,
  );

  static const List<AdminCountry> all = [usa, mexico];

  // Helper methods
  String formatDistance(double distance) {
    return '${distance.toStringAsFixed(1)}$distanceUnit';
  }

  String formatCurrency(double amount) {
    return '$currencySymbol${amount.toStringAsFixed(2)} $currency';
  }

  // Convert miles to km if needed
  double convertDistance(double miles) {
    if (usesMetric) {
      return miles * 1.60934; // miles to km
    }
    return miles;
  }

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is AdminCountry && code == other.code;

  @override
  int get hashCode => code.hashCode;
}
```

## PASO 2.2: Verificar Provider Existe
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/providers/admin_country_provider.dart

DEBE existir ya (se vio en el c√≥digo). Si NO existe, crear:

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/admin_country.dart';

/// Provider for selected country in admin
final adminCountryProvider = StateProvider<AdminCountry>((ref) {
  return AdminCountry.usa; // Default
});
```

## PASO 2.3: Crear UI Helper
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/utils/country_ui_helper.dart

```dart
import '../models/admin_country.dart';

/// UI helper for country-specific labels and formatting
class CountryUIHelper {
  final AdminCountry country;

  const CountryUIHelper(this.country);

  // Distance labels
  String get distanceLabel => country.isMexico ? 'Distancia' : 'Distance';
  String get distancePerUnit => country.isMexico ? 'Por KM' : 'Per Mile';

  // Pricing labels
  String get baseFareLabel => country.isMexico ? 'Tarifa Base' : 'Base Fare';
  String get perMinuteLabel => country.isMexico ? 'Por Minuto' : 'Per Minute';
  String get minimumFareLabel => country.isMexico ? 'Tarifa M√≠nima' : 'Minimum Fare';
  String get bookingFeeLabel => country.isMexico ? 'Cargo de Reserva' : 'Booking Fee';
  String get serviceFeeLabel => country.isMexico ? 'Cargo de Servicio' : 'Service Fee';

  // Format helpers
  String formatDistance(double distance) => country.formatDistance(distance);
  String formatCurrency(double amount) => country.formatCurrency(amount);

  // Tax labels
  String get taxLabel => country.isMexico ? 'IVA (16%)' : 'Tax';

  // Driver labels
  String get driverLabel => country.isMexico ? 'Conductor' : 'Driver';
  String get riderLabel => country.isMexico ? 'Pasajero' : 'Rider';
}
```


================================================================================
FASE 3: ADMIN PRICING SCREEN - FIX CRITICAL BUGS
================================================================================

## PASO 3.1: Fix "Per Mile" ‚Üí Dynamic Label
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/admin_pricing_screen.dart

BUSCAR (l√≠nea ~40-45 aproximadamente):
```dart
double _perMileRate = 0;
```

CAMBIAR TODAS las referencias de "Per Mile" a din√°micas:

EJEMPLO - En la UI donde muestra "Per Mile":
```dart
// ANTES:
Text('Per Mile'),

// DESPU√âS:
final country = ref.watch(adminCountryProvider);
Text(country.isMexico ? 'Por KM' : 'Per Mile'),
```

BUSCAR en todo el archivo:
- "Per Mile" ‚Üí reemplazar con condicional
- "per mile" ‚Üí reemplazar con condicional
- "_perMileRate" ‚Üí cambiar nombre a "_perDistanceRate" (m√°s gen√©rico)

LUGARES CR√çTICOS a cambiar:
1. Variable name: _perMileRate ‚Üí _perDistanceRate
2. Label en TARIFAS section
3. Label en Calculadora
4. Cualquier tooltip o hint text


## PASO 3.2: Fix Distance Display en Trips Screen
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/admin_rides_screen.dart (o admin_trips_screen.dart)

BUSCAR columna "DISTANCIA":

ANTES:
```dart
Text('${ride.distance}mi')
```

DESPU√âS:
```dart
final country = ref.watch(adminCountryProvider);
final uiHelper = CountryUIHelper(country);
Text(uiHelper.formatDistance(ride.distance))
```

## PASO 3.3: Agregar Filtro por Country en Queries
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/admin_rides_screen.dart

BUSCAR m√©todo que carga rides (probablemente en initState o un provider):

ANTES:
```dart
final rides = await supabase
  .from('rides')
  .select('*')
  .order('created_at', ascending: false);
```

DESPU√âS:
```dart
final country = ref.read(adminCountryProvider);
final rides = await supabase
  .from('rides')
  .select('*')
  .eq('country_code', country.code)  // ‚Üê FILTRO CR√çTICO
  .order('created_at', ascending: false);
```

APLICAR ESTE CAMBIO EN:
- [ ] admin_rides_screen.dart (getRides, getActiveRides, etc.)
- [ ] admin_drivers_screen.dart (getDrivers)
- [ ] admin_users_screen.dart (getUsers/getRiders)
- [ ] finance/transactions_screen.dart (getTransactions)
- [ ] finance/driver_payouts_screen.dart (getPayouts)
- [ ] admin_support_screen.dart (getTickets)
- [ ] admin_analytics_screen.dart (todas las queries)


================================================================================
FASE 4: FINANCE - AGREGAR FILTRO DE PA√çS
================================================================================

## PASO 4.1: Finance Overview
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/finance/screens/finance_overview_screen.dart

AGREGAR al query de revenue:

```dart
final country = ref.watch(adminCountryProvider);

// Revenue query
final revenue = await supabase
  .from('transactions_revenue')
  .select('amount')
  .eq('country_code', country.code)  // ‚Üê NUEVO
  .gte('created_at', startDate)
  .lte('created_at', endDate);
```

## PASO 4.2: Transactions Screen
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/finance/screens/transactions_screen.dart

MISMO cambio en loadTransactions():

```dart
.eq('country_code', country.code)
```

## PASO 4.3: Driver Payouts
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/finance/screens/driver_payouts_screen.dart

Agregar filtro en query de payouts:

```dart
final country = ref.watch(adminCountryProvider);

final payouts = await supabase
  .from('driver_earnings')
  .select('*, drivers!inner(*)')
  .eq('drivers.country_code', country.code)  // ‚Üê NUEVO
  .order('week_start', ascending: false);
```


================================================================================
FASE 5: ADMIN MEXICO - CREAR SCREENS FALTANTES
================================================================================

## PASO 5.1: Admin Mexico Documents Screen
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/mexico/admin_mexico_documents_screen.dart

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/services/supabase_service.dart';
import '../enterprise/enterprise_admin_shell.dart';

class AdminMexicoDocumentsScreen extends ConsumerStatefulWidget {
  const AdminMexicoDocumentsScreen({super.key});

  @override
  ConsumerState<AdminMexicoDocumentsScreen> createState() =>
      _AdminMexicoDocumentsScreenState();
}

class _AdminMexicoDocumentsScreenState
    extends ConsumerState<AdminMexicoDocumentsScreen> {
  bool _isLoading = true;
  List<Map<String, dynamic>> _drivers = [];
  String _filterStatus = 'all'; // all, pending, approved, rejected, expired

  @override
  void initState() {
    super.initState();
    _loadDrivers();
  }

  Future<void> _loadDrivers() async {
    setState(() => _isLoading = true);

    try {
      final supabase = SupabaseService.instance.client;

      // Get Mexican drivers with their documents
      var query = supabase
          .from('drivers')
          .select('''
            *,
            driver_documents_mx(*)
          ''')
          .eq('country_code', 'MX')
          .order('created_at', ascending: false);

      final data = await query;
      setState(() {
        _drivers = List<Map<String, dynamic>>.from(data);
        _isLoading = false;
      });
    } catch (e) {
      setState(() => _isLoading = false);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error loading drivers: $e')),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return EnterpriseAdminShell(
      currentRoute: '/admin/mexico/documents',
      title: 'Documentos M√©xico üá≤üáΩ',
      child: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : Column(
              children: [
                // Header with filters
                _buildHeader(),
                const SizedBox(height: 16),

                // Drivers table
                Expanded(child: _buildDriversTable()),
              ],
            ),
    );
  }

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Row(
        children: [
          const Text(
            'Drivers Mexicanos',
            style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
          ),
          const SizedBox(width: 16),
          SegmentedButton<String>(
            segments: const [
              ButtonSegment(value: 'all', label: Text('Todos')),
              ButtonSegment(value: 'pending', label: Text('Pendientes')),
              ButtonSegment(value: 'approved', label: Text('Aprobados')),
              ButtonSegment(value: 'rejected', label: Text('Rechazados')),
              ButtonSegment(value: 'expired', label: Text('Expirados')),
            ],
            selected: {_filterStatus},
            onSelectionChanged: (Set<String> selected) {
              setState(() => _filterStatus = selected.first);
              // TODO: Apply filter
            },
          ),
          const Spacer(),
          ElevatedButton.icon(
            onPressed: _loadDrivers,
            icon: const Icon(Icons.refresh),
            label: const Text('Refresh'),
          ),
        ],
      ),
    );
  }

  Widget _buildDriversTable() {
    if (_drivers.isEmpty) {
      return const Center(
        child: Text('No hay drivers mexicanos'),
      );
    }

    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      child: DataTable(
        columns: const [
          DataColumn(label: Text('Driver')),
          DataColumn(label: Text('Email')),
          DataColumn(label: Text('Estado')),
          DataColumn(label: Text('INE')),
          DataColumn(label: Text('RFC')),
          DataColumn(label: Text('Licencia E1')),
          DataColumn(label: Text('Tarjet√≥n')),
          DataColumn(label: Text('Seguro')),
          DataColumn(label: Text('Status')),
          DataColumn(label: Text('Acciones')),
        ],
        rows: _drivers.map((driver) => _buildDriverRow(driver)).toList(),
      ),
    );
  }

  DataRow _buildDriverRow(Map<String, dynamic> driver) {
    final docs = driver['driver_documents_mx'] as List?;

    return DataRow(
      cells: [
        DataCell(Text(driver['name'] ?? 'Sin nombre')),
        DataCell(Text(driver['email'] ?? '')),
        DataCell(Text(driver['state'] ?? '')),
        DataCell(_buildDocStatus(docs, 'ine')),
        DataCell(_buildDocStatus(docs, 'rfc')),
        DataCell(_buildDocStatus(docs, 'licencia_e1')),
        DataCell(_buildDocStatus(docs, 'tarjeton_semovi')),
        DataCell(_buildDocStatus(docs, 'seguro_ert')),
        DataCell(_buildOverallStatus(docs)),
        DataCell(
          Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              IconButton(
                icon: const Icon(Icons.visibility),
                onPressed: () => _viewDriverDocs(driver),
                tooltip: 'Ver documentos',
              ),
              IconButton(
                icon: const Icon(Icons.check, color: Colors.green),
                onPressed: () => _approveDriver(driver),
                tooltip: 'Aprobar',
              ),
              IconButton(
                icon: const Icon(Icons.close, color: Colors.red),
                onPressed: () => _rejectDriver(driver),
                tooltip: 'Rechazar',
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildDocStatus(List? docs, String docType) {
    if (docs == null || docs.isEmpty) {
      return const Icon(Icons.remove, color: Colors.grey, size: 16);
    }

    final doc = docs.firstWhere(
      (d) => d['document_type'] == docType,
      orElse: () => null,
    );

    if (doc == null) {
      return const Icon(Icons.remove, color: Colors.grey, size: 16);
    }

    final status = doc['verification_status'];
    final icon = status == 'approved'
        ? Icons.check_circle
        : status == 'rejected'
            ? Icons.cancel
            : Icons.pending;

    final color = status == 'approved'
        ? Colors.green
        : status == 'rejected'
            ? Colors.red
            : Colors.orange;

    return Icon(icon, color: color, size: 16);
  }

  Widget _buildOverallStatus(List? docs) {
    // TODO: Implement logic to check if all required docs are approved
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: Colors.orange.withOpacity(0.2),
        borderRadius: BorderRadius.circular(4),
      ),
      child: const Text(
        'Pendiente',
        style: TextStyle(color: Colors.orange, fontSize: 12),
      ),
    );
  }

  void _viewDriverDocs(Map<String, dynamic> driver) {
    // TODO: Open dialog with driver documents
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Documentos - ${driver['name']}'),
        content: const Text('TODO: Mostrar documentos con im√°genes'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cerrar'),
          ),
        ],
      ),
    );
  }

  void _approveDriver(Map<String, dynamic> driver) async {
    // TODO: Implement approval logic
    // Update driver status to approved
    // Send notification to driver
  }

  void _rejectDriver(Map<String, dynamic> driver) async {
    // TODO: Implement rejection logic
    // Update driver status to rejected
    // Send notification to driver with reason
  }
}
```

## PASO 5.2: Agregar Ruta
--------------------------------------------------------------------------------
ARCHIVO: lib/core/router/app_router.dart

AGREGAR import:
```dart
import '../../features/admin/mexico/admin_mexico_documents_screen.dart';
```

AGREGAR ruta (buscar secci√≥n de admin routes):
```dart
GoRoute(
  path: '/admin/mexico/documents',
  builder: (context, state) => const AdminMexicoDocumentsScreen(),
),
```

## PASO 5.3: Agregar en Sidebar
--------------------------------------------------------------------------------
ARCHIVO: lib/features/admin/enterprise/enterprise_admin_shell.dart

BUSCAR secci√≥n de navigation items y AGREGAR:

```dart
// Secci√≥n M√©xico (solo mostrar si country = MX)
if (selectedCountry.isMexico) ...[
  _NavigationSection(
    title: 'M√âXICO',
    items: [
      _NavItem(
        route: '/admin/mexico/documents',
        icon: Icons.description,
        label: 'Documentos',
      ),
      _NavItem(
        route: '/admin/mexico/tax',
        icon: Icons.account_balance,
        label: 'Impuestos',
      ),
      _NavItem(
        route: '/admin/mexico/cfdi',
        icon: Icons.receipt_long,
        label: 'Facturas CFDI',
      ),
    ],
  ),
],
```


================================================================================
FASE 6: TESTING
================================================================================

## CHECKLIST DE TESTING
--------------------------------------------------------------------------------

### TEST 1: Database
[ ] Migration 010 aplicada sin errores
[ ] Columna country_code existe en rides, deliveries, drivers, profiles
[ ] Todos los registros existentes tienen country_code = 'US'
[ ] √çndices creados correctamente

### TEST 2: Country Switch
[ ] Cambiar pa√≠s a M√©xico muestra bandera üá≤üáΩ
[ ] Labels cambian a espa√±ol (Por KM, Tarifa Base, etc.)
[ ] Distancia se muestra en km
[ ] Currency muestra MXN

### TEST 3: Data Filtering
[ ] Trips screen con M√©xico muestra SOLO rides con country_code = 'MX'
[ ] Trips screen con USA muestra SOLO rides con country_code = 'US'
[ ] Drivers screen filtra correctamente
[ ] Finance filtra correctamente

### TEST 4: Pricing
[ ] Pricing M√©xico muestra "Por KM" (no "Per Mile")
[ ] Calculadora usa km cuando country = MX
[ ] C√°lculo de tarifa correcto con km

### TEST 5: New Screens
[ ] /admin/mexico/documents carga
[ ] Muestra drivers mexicanos
[ ] Filtros funcionan

### TEST 6: No Romper USA
[ ] Con country = USA todo funciona igual que antes
[ ] No hay regresiones
[ ] Distancia sigue mostrando millas
[ ] Finance muestra USD


================================================================================
FASE 7: DATA MIGRATION (OPCIONAL - SI HAY DATOS MX)
================================================================================

## Si ya hay rides/drivers de M√©xico que est√°n marcados como 'US':
--------------------------------------------------------------------------------

```sql
-- Identificar rides de M√©xico (ejemplo: por zona geogr√°fica)
UPDATE public.rides
SET country_code = 'MX'
WHERE pickup_lat BETWEEN 14 AND 33   -- Latitud de M√©xico
  AND pickup_lng BETWEEN -118 AND -86; -- Longitud de M√©xico

-- Identificar drivers de M√©xico (ejemplo: por phone prefix)
UPDATE public.drivers
SET country_code = 'MX'
WHERE phone LIKE '+52%';  -- C√≥digo de pa√≠s M√©xico

-- Verificar
SELECT country_code, COUNT(*)
FROM public.rides
GROUP BY country_code;
```


================================================================================
CHECKLIST COMPLETO - MARCAR AL COMPLETAR
================================================================================

FASE 1: DATABASE
[ ] Migration 010 creada
[ ] Migration 010 aplicada
[ ] country_code en rides
[ ] country_code en deliveries
[ ] country_code en drivers
[ ] country_code en profiles
[ ] √çndices creados
[ ] Datos migrados a 'US'

FASE 2: FLUTTER MODELS
[ ] AdminCountry model creado
[ ] adminCountryProvider existe
[ ] CountryUIHelper creado

FASE 3: PRICING FIXES
[ ] "Per Mile" ‚Üí din√°mico
[ ] _perMileRate ‚Üí _perDistanceRate
[ ] Labels en espa√±ol para MX
[ ] Calculadora usa km para MX

FASE 4: SCREENS - AGREGAR FILTROS
[ ] admin_rides_screen.dart
[ ] admin_drivers_screen.dart
[ ] admin_users_screen.dart
[ ] finance/finance_overview_screen.dart
[ ] finance/transactions_screen.dart
[ ] finance/driver_payouts_screen.dart
[ ] admin_support_screen.dart
[ ] admin_analytics_screen.dart

FASE 5: MEXICO SCREENS
[ ] admin_mexico_documents_screen.dart creado
[ ] Ruta agregada en app_router.dart
[ ] Sidebar item agregado
[ ] (Opcional) admin_mexico_tax_screen.dart
[ ] (Opcional) admin_mexico_cfdi_screen.dart

FASE 6: TESTING
[ ] Todos los tests pasados (ver checklist arriba)

FASE 7: DATA MIGRATION
[ ] (Si aplica) Datos MX migrados


================================================================================
COMANDOS √öTILES
================================================================================

# Ver logs de Supabase
supabase functions logs <function-name>

# Aplicar migration
cd supabase
supabase db push

# Ver cambios pendientes
supabase db diff

# Reset local (CUIDADO - borra datos locales)
supabase db reset

# Deploy edge function
supabase functions deploy <function-name>

# Flutter
flutter pub get
flutter run
flutter test


================================================================================
NOTAS IMPORTANTES
================================================================================

1. NO DUPLICAR C√ìDIGO
   - Usar country switch para todo
   - UN screen para ambos pa√≠ses

2. NO ROMPER USA
   - Default siempre 'US'
   - Agregar filtros NO cambia comportamiento existente

3. MIGRACI√ìN GRADUAL
   - Aplicar cambios por fases
   - Testing despu√©s de cada fase
   - Rollback si algo falla

4. PERFORMANCE
   - √çndices en country_code
   - Queries filtradas desde el inicio
   - No cargar todo y filtrar en memoria

5. FUTURO
   - F√°cil agregar m√°s pa√≠ses (CA, etc.)
   - Ya est√° la estructura


================================================================================
BUGS CONOCIDOS A RESOLVER (de BUGS_Y_CORRECCIONES_MEXICO_MASTER.txt)
================================================================================

DESPU√âS de implementar este plan, resolver:
- BUG #4: state vs state_code
- BUG #5: per_minute vs per_min
- BUG #6: service_type vs vehicle_type
- FALTA #8: Payment method fees
- FALTA #11: Cobertura geogr√°fica (agregar m√°s estados)


================================================================================
FIN DEL PLAN DE IMPLEMENTACI√ìN
================================================================================
Pr√≥ximo Claude: Lee este documento l√≠nea por l√≠nea y ejecuta cada paso.
Marca los checkboxes conforme completes cada tarea.
NO asumas nada, sigue el plan exactamente.
