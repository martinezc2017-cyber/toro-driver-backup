================================================================================
PLAN PARA SIGUIENTE CLAUDE: IMPLEMENTAR TORO EN MEXICO
================================================================================
Fecha: 2026-01-30
Estado: PENDIENTE DE IMPLEMENTACION
================================================================================

INSTRUCCIONES PARA EL SIGUIENTE CLAUDE:
---------------------------------------
Este documento contiene TODO lo que necesitas saber para implementar el soporte
de Mexico en las apps Toro (Driver + Rider + Admin). Lee completo antes de
empezar a codificar.

ARCHIVOS RELACIONADOS EN ESTE PROYECTO:
- PLAN_MX_COMPLETO.txt (plan tecnico detallado)
- ANALISIS_MX_3_APPS.txt (gaps encontrados en las 3 apps)
- Este archivo (requisitos legales + roadmap)

================================================================================
PARTE 1: REQUISITOS LEGALES MEXICO (INVESTIGACION WEB 2026)
================================================================================

------------------------------------------------------------------------------
1.1 REGULACION DE PLATAFORMAS DE TRANSPORTE EN MEXICO
------------------------------------------------------------------------------

MARCO LEGAL ACTUAL:
- El Congreso de CDMX aprobo reformas que establecen certificacion obligatoria
  para conductores de plataformas digitales (2025)
- Los conductores deben obtener Constancia de Registro expedida por SEMOVI
- Los vehiculos requieren Constancia de Registro Vehicular (costo: $2,246 MXN)
- Ambos documentos tienen vigencia de 1 a単o

REFORMA LABORAL (JUNIO 2025):
- Conductores de apps ahora tienen acceso a seguridad social
- Acceso a vivienda digna (INFONAVIT)
- La plataforma debe facilitar estos derechos

REQUISITOS PARA PLATAFORMAS:
- Herramientas digitales accesibles
- Tarifas claras y transparentes
- Opciones de pago electronico Y efectivo
- Proteccion de datos personales
- Certificacion periodica de conductores
- Accesibilidad para personas vulnerables

FUENTES:
- https://todotaxi.org/decreto-de-regulacion-de-uber-didi-y-cabify-en-cdmx/
- https://www.nmas.com.mx/ciudad-de-mexico/congreso-cdmx-aprueba-regulacion-conductores-aplicacion-deban-certificarse-periodicamente-operar/

------------------------------------------------------------------------------
1.2 REQUISITOS PARA CONDUCTORES EN MEXICO
------------------------------------------------------------------------------

DOCUMENTOS OBLIGATORIOS:

A) LICENCIA DE CONDUCIR:
   - CDMX: Licencia tipo E1 (especial para apps)
   - Requisitos para E1:
     * Licencia tipo A vigente con 3 a単os de antiguedad
     * Curso y prueba de manejo en CENFES
     * Aprobacion de documentos por SEMOVI
   - Otras ciudades: Licencia tipo A o B segun estado
   - Licencia permanente CDMX es valida ($1,500 MXN hasta dic 2025)

B) TARJETON DE CONDUCTOR (CDMX):
   - Obligatorio para operar
   - Requiere licencia tipo A o E expedida en CDMX
   - Carta de no antecedentes penales

C) IDENTIFICACION:
   - INE/IFE vigente
   - RFC activo (obligatorio para retenciones)

D) DOCUMENTOS VEHICULARES:
   - Tarjeta de circulacion vigente
   - Constancia de Registro Vehicular (SEMOVI)
   - Seguro vehicular ERT vigente

FUENTES:
- https://floty.mx/blog/didi-conductor-mexico-requisitos/
- https://www.autofact.com.mx/blog/mi-carro/conduccion/licencia-e1
- https://www.rastreator.mx/seguro-ert/licencia-de-conducir-para-uber-didi-cabify-beat

------------------------------------------------------------------------------
1.3 REQUISITOS DE VEHICULOS
------------------------------------------------------------------------------

REQUISITOS GENERALES:
- 4 puertas minimo
- Espacio para 4+ pasajeros
- Aire acondicionado funcional
- Frenos ABS
- Bolsas de aire

ANTIGUEDAD:
- CDMX: Maximo 8 a単os de antiguedad
- Otras ciudades: Maximo 10 a単os

PROHIBICIONES:
- No pickups ni convertibles (2 puertas)
- No vehiculos con placas de taxi
- No vehiculos de servicio publico

FUENTES:
- https://www.elfinanciero.com.mx/cdmx/2023/11/09/cdmx-se-pone-piki-con-uber-y-didi-que-caracteristicas-deben-cumplir-los-autos/

------------------------------------------------------------------------------
1.4 SEGUROS OBLIGATORIOS
------------------------------------------------------------------------------

TIPO DE SEGURO REQUERIDO:
- Seguro ERT (Empresas de Redes de Transporte)
- NO sirve seguro particular (no cubre uso comercial)

COBERTURAS MINIMAS:
- Responsabilidad Civil: $3,000,000 MXN minimo
- Gastos medicos conductor y pasajeros
- Proteccion legal

COBERTURAS RECOMENDADAS (Cobertura Amplia):
- Danos materiales propios
- Robo total
- Asistencia vial
- Defensa legal

ASEGURADORAS QUE OFRECEN ERT:
- AXA (Protect App)
- Banorte (Socio Conductor App)
- GNP (Chofer Privado)
- Qualitas
- Sura (Tu Complemento)
- Clupp
- La Latino

COSTOS ESTIMADOS:
- Desde $9,000 MXN anuales (basico)
- $15,000-25,000 MXN (cobertura amplia)

IMPORTANTE PARA LA APP:
- Validar que conductor tenga seguro ERT vigente
- Guardar numero de poliza y vigencia
- Alertar cuando este por vencer

FUENTES:
- https://ahorraseguros.mx/seguros-de-autos/guias/seguro-de-auto-para-plataformas/
- https://www.rastreator.mx/seguros-de-uber-didi-cabify-beat

------------------------------------------------------------------------------
1.5 REQUISITOS FISCALES (SAT)
------------------------------------------------------------------------------

REGIMEN FISCAL CONDUCTORES:
- "Regimen de Plataformas Tecnologicas" (articulos 113-A, 113-B, 113-C LISR)
- O RESICO si ingresos < $3.5 millones anuales

RFC OBLIGATORIO:
- Conductor DEBE tener RFC activo
- Sin RFC: retencion sube a 20% ISR (vs 2.5%)
- Plataforma debe solicitar RFC antes de activar conductor

RETENCIONES 2026 (LA PLATAFORMA DEBE RETENER):

ISR (Impuesto Sobre la Renta):
- CON RFC: 2.5% del ingreso
- SIN RFC: 20% del ingreso
- La plataforma retiene y paga al SAT

IVA (Impuesto al Valor Agregado):
- Conductor causa 16% IVA
- Plataforma retiene 8% (mitad)
- Conductor paga el otro 8% directo al SAT

PAGO DEFINITIVO (OPCION):
- Si ingresos < $300,000 anuales
- Retencion de plataforma = pago definitivo
- No requiere declaracion adicional

OBLIGACIONES DE LA PLATAFORMA:
- Retener ISR e IVA de cada viaje
- Enterar al SAT mensualmente
- Emitir constancias de retencion
- Reportar ingresos de conductores al SAT

FUENTES:
- https://contadoresmismolenguaje.mx/inicio/blog/retencion-iva-isr-plataformas
- https://blog.gigstack.pro/post/uber-didi-2026-guia-retenciones-sat-conductores-mexico
- https://www.sat.gob.mx/minisitio/PlataformasTecnologicas/

------------------------------------------------------------------------------
1.6 FACTURACION CFDI 4.0
------------------------------------------------------------------------------

QUE ES CFDI:
- Comprobante Fiscal Digital por Internet
- Version vigente: 4.0 (desde abril 2023)
- Obligatorio para todas las transacciones en Mexico

DATOS OBLIGATORIOS EN CFDI 4.0:
- RFC del emisor
- Regimen fiscal del emisor
- Domicilio fiscal del emisor
- RFC del receptor
- Regimen fiscal del receptor
- Domicilio fiscal del receptor (CP)
- Uso del CFDI (clave)

CLAVES USO CFDI RELEVANTES:
- G03: Gastos en general
- I01: Construcciones
- I03: Equipo de transporte
- D01: Honorarios medicos
- S01: Sin efectos fiscales (cuando no es deducible)

COMPLEMENTO CARTA PORTE:
- Obligatorio para transporte de mercancias
- Multa sin carta porte: $450-$670 por factura
- Para rideshare de pasajeros: NO aplica carta porte

IMPLEMENTACION EN LA APP:
- Opcion para que rider solicite factura
- Capturar RFC y regimen fiscal del rider
- Integrar con PAC (Proveedor Autorizado de Certificacion)
- Generar CFDI con UUID (folio fiscal)
- Enviar XML y PDF al rider

PROVEEDORES PAC RECOMENDADOS:
- Facturama
- SW Sapien
- Finkok
- Digicel

FUENTES:
- https://www.sat.gob.mx/aplicacion/75169/servicio-de-facturacion-cfdi-version-4.0
- https://xpd.mx/blog/catalogo-de-claves-usos-de-cfdi-4-0-consulta-en-linea.html

================================================================================
PARTE 2: REQUISITOS TECNICOS A IMPLEMENTAR
================================================================================

------------------------------------------------------------------------------
2.1 BACKEND (SUPABASE)
------------------------------------------------------------------------------

TABLAS NUEVAS A CREAR:

1. countries
   - code (MX, US)
   - name
   - currency (MXN, USD)
   - tax_rate (0.16 para MX)
   - stripe_provider
   - is_active

2. driver_documents_mx
   - driver_id
   - document_type (ine, licencia_e1, tarjeton, rfc, seguro_ert, constancia_vehicular)
   - document_number
   - issue_date
   - expiry_date
   - file_url
   - verification_status
   - verified_at
   - verified_by

3. tax_retentions
   - transaction_id
   - driver_id
   - gross_amount
   - isr_rate (0.025 o 0.20)
   - isr_amount
   - iva_rate (0.08)
   - iva_amount
   - net_amount
   - has_rfc (boolean)
   - period (YYYY-MM)

4. cfdi_invoices
   - id
   - ride_id
   - rider_id
   - uuid_fiscal
   - rfc_emisor
   - rfc_receptor
   - regimen_receptor
   - cp_receptor
   - uso_cfdi
   - subtotal
   - iva
   - total
   - xml_url
   - pdf_url
   - status
   - created_at

5. fx_rates
   - base_currency
   - quote_currency
   - rate
   - source
   - fetched_at

6. pricing_zones_mx
   - id
   - name
   - state_code (CDMX, JAL, NL, etc)
   - polygon (geography)

7. pricing_rules_mx
   - zone_id
   - service_type
   - base_fare
   - per_km
   - per_min
   - min_fare
   - night_multiplier
   - surge_multiplier
   - effective_from
   - effective_to

MODIFICACIONES A TABLAS EXISTENTES:

drivers:
  + country_code
  + rfc
  + has_rfc_validated
  + license_type (E1, A, B)
  + insurance_policy_number
  + insurance_expiry
  + semovi_constancia
  + semovi_vehicular

rides:
  + country_code
  + currency
  + fx_rate_applied
  + isr_retained
  + iva_retained

driver_stripe_accounts:
  + provider (us, mx)
  - Cambiar UNIQUE de (driver_id) a (driver_id, provider)

------------------------------------------------------------------------------
2.2 EDGE FUNCTIONS NUEVAS
------------------------------------------------------------------------------

1. calculate-tax-retention
   Input: driver_id, gross_amount
   Output: isr_amount, iva_amount, net_amount
   Logica:
   - Verificar si driver tiene RFC
   - Si tiene RFC: ISR 2.5%, IVA 8%
   - Si NO tiene RFC: ISR 20%, IVA 8%
   - Guardar en tax_retentions

2. generate-cfdi
   Input: ride_id, rider_rfc, rider_regimen, rider_cp, uso_cfdi
   Output: uuid_fiscal, xml_url, pdf_url
   Logica:
   - Conectar con PAC (Facturama/SW Sapien)
   - Generar CFDI 4.0
   - Guardar en cfdi_invoices
   - Enviar por email

3. validate-driver-documents-mx
   Input: driver_id, document_type, document_data
   Output: is_valid, errors[]
   Logica:
   - Validar formato RFC (13 caracteres)
   - Validar vigencia licencia
   - Validar vigencia seguro
   - Marcar documento como verificado

4. get-retention-report
   Input: driver_id, period (YYYY-MM)
   Output: lista de retenciones, totales
   Logica:
   - Sumar retenciones del periodo
   - Generar constancia de retencion

------------------------------------------------------------------------------
2.3 EDGE FUNCTIONS A MODIFICAR
------------------------------------------------------------------------------

stripe-process-split:
  - Agregar calculo de retenciones MX
  - Guardar isr_retained, iva_retained en rides
  - Insertar en tax_retentions

stripe-create-payout:
  - Descontar retenciones antes de payout
  - Solo transferir net_amount

------------------------------------------------------------------------------
2.4 APP DRIVER - CAMBIOS
------------------------------------------------------------------------------

NUEVAS PANTALLAS:

1. DocumentosMexicoScreen
   - Subir INE
   - Subir Licencia E1 / tipo A
   - Subir Tarjeton de conductor
   - Ingresar RFC
   - Subir poliza seguro ERT
   - Subir Constancia SEMOVI
   - Subir Constancia Vehicular
   - Mostrar estatus de verificacion
   - Alertas de vencimiento

2. RetencionesScreen
   - Ver retenciones ISR e IVA por periodo
   - Descargar constancia de retencion
   - Explicacion de regimen fiscal

3. ConfiguracionFiscalScreen
   - Ingresar/actualizar RFC
   - Ver regimen fiscal
   - Configurar si quiere pago definitivo

MODIFICACIONES:

RegistrationScreen:
  - Agregar flujo para Mexico
  - Pedir RFC desde registro
  - Validar documentos MX

EarningsScreen:
  - Mostrar desglose: bruto, ISR, IVA, neto
  - Mostrar retenciones acumuladas del mes

ProfileScreen:
  - Mostrar documentos y vigencias
  - Alerta si algo esta por vencer

------------------------------------------------------------------------------
2.5 APP RIDER - CAMBIOS
------------------------------------------------------------------------------

NUEVAS PANTALLAS:

1. SolicitarFacturaScreen
   - Ingresar RFC
   - Seleccionar regimen fiscal
   - Ingresar CP
   - Seleccionar uso CFDI
   - Confirmar datos

2. MisFacturasScreen
   - Lista de facturas emitidas
   - Descargar XML y PDF
   - Reenviar por email

MODIFICACIONES:

RideReceiptScreen:
   - Boton "Solicitar Factura"
   - Si ya tiene factura, mostrar link

PaymentScreen:
   - Mostrar desglose con IVA
   - Subtotal + IVA = Total

ProfileScreen:
   - Guardar datos fiscales (RFC, regimen, CP)
   - Para no pedir en cada factura

------------------------------------------------------------------------------
2.6 ADMIN WEB - CAMBIOS
------------------------------------------------------------------------------

NUEVAS PANTALLAS:

1. AdminDocumentosMxScreen
   - Ver documentos pendientes de verificacion
   - Aprobar/rechazar documentos
   - Ver historial de verificaciones

2. AdminRetencionesScreen
   - Ver retenciones por conductor
   - Generar reporte mensual para SAT
   - Exportar a Excel/CSV

3. AdminFacturasScreen
   - Ver facturas emitidas
   - Cancelar facturas
   - Reenviar facturas

4. AdminPricingMxScreen
   - Configurar zonas de Mexico
   - Configurar tarifas por zona
   - Configurar multiplicadores

MODIFICACIONES:

AdminDriversScreen:
   - Filtrar por pais
   - Ver estatus documentos MX
   - Ver si tiene RFC valido

AdminFinancesScreen:
   - Mostrar retenciones
   - Separar por pais/moneda

================================================================================
PARTE 3: ORDEN DE IMPLEMENTACION
================================================================================

FASE 1: FUNDAMENTOS (Backend)
-----------------------------
1. Crear migraciones SQL (tablas nuevas)
2. Modificar tablas existentes (agregar campos)
3. Crear edge function: calculate-tax-retention
4. Modificar stripe-process-split para retenciones
5. Probar con datos de prueba

FASE 2: DOCUMENTOS Y VERIFICACION
---------------------------------
6. Crear pantalla DocumentosMexicoScreen (driver)
7. Crear edge function: validate-driver-documents-mx
8. Crear AdminDocumentosMxScreen
9. Flujo completo de verificacion

FASE 3: FACTURACION CFDI
------------------------
10. Integrar con PAC (Facturama recomendado)
11. Crear edge function: generate-cfdi
12. Crear SolicitarFacturaScreen (rider)
13. Crear MisFacturasScreen (rider)
14. Crear AdminFacturasScreen

FASE 4: PRECIOS Y ZONAS
-----------------------
15. Crear tablas pricing_zones_mx, pricing_rules_mx
16. Crear AdminPricingMxScreen
17. Modificar cotizacion para usar zonas MX
18. Agregar multiplicadores (noche, surge)

FASE 5: REPORTES Y COMPLIANCE
-----------------------------
19. Crear RetencionesScreen (driver)
20. Crear AdminRetencionesScreen
21. Generar reportes mensuales SAT
22. Constancias de retencion

FASE 6: PULIDO
--------------
23. Locale es-MX completo
24. Validacion telefono +52
25. Testing completo
26. Documentacion

================================================================================
PARTE 4: DATOS DE CONFIGURACION MEXICO
================================================================================

ENTIDADES FEDERATIVAS (32):
---------------------------
CDMX  - Ciudad de Mexico
AGS   - Aguascalientes
BC    - Baja California
BCS   - Baja California Sur
CAM   - Campeche
CHIS  - Chiapas
CHIH  - Chihuahua
COAH  - Coahuila
COL   - Colima
DGO   - Durango
GTO   - Guanajuato
GRO   - Guerrero
HGO   - Hidalgo
JAL   - Jalisco
MEX   - Estado de Mexico
MICH  - Michoacan
MOR   - Morelos
NAY   - Nayarit
NL    - Nuevo Leon
OAX   - Oaxaca
PUE   - Puebla
QRO   - Queretaro
QROO  - Quintana Roo
SLP   - San Luis Potosi
SIN   - Sinaloa
SON   - Sonora
TAB   - Tabasco
TAMPS - Tamaulipas
TLAX  - Tlaxcala
VER   - Veracruz
YUC   - Yucatan
ZAC   - Zacatecas

ZONAS HORARIAS MEXICO:
----------------------
America/Mexico_City  (UTC-6) - CDMX, Jalisco, mayoria del pais
America/Cancun       (UTC-5) - Quintana Roo
America/Hermosillo   (UTC-7) - Sonora (sin horario de verano)
America/Tijuana      (UTC-8) - Baja California

IMPUESTOS:
----------
IVA Nacional: 16%
ISR Retencion (con RFC): 2.5%
ISR Retencion (sin RFC): 20%
IVA Retencion: 8% (50% del IVA)

TARIFAS SUGERIDAS (MXN):
------------------------
CDMX:
  base_fare: 35.00
  per_km: 8.50
  per_min: 2.50
  min_fare: 50.00
  night_multiplier: 1.25 (22:00-06:00)

Guadalajara (JAL):
  base_fare: 30.00
  per_km: 7.50
  per_min: 2.00
  min_fare: 45.00
  night_multiplier: 1.20

Monterrey (NL):
  base_fare: 32.00
  per_km: 8.00
  per_min: 2.20
  min_fare: 48.00
  night_multiplier: 1.20

FORMATO RFC MEXICO:
-------------------
Persona Fisica: 4 letras + 6 digitos fecha + 3 homoclave = 13 caracteres
Ejemplo: GARC850101XXX

Persona Moral: 3 letras + 6 digitos fecha + 3 homoclave = 12 caracteres
Ejemplo: ABC850101XXX

FORMATO TELEFONO MEXICO:
------------------------
+52 1 XX XXXX XXXX (celular)
+52 XX XXXX XXXX (fijo)

Codigos de area principales:
55 - CDMX y area metropolitana
33 - Guadalajara
81 - Monterrey
222 - Puebla
477 - Leon
999 - Merida

================================================================================
PARTE 5: VARIABLES DE ENTORNO REQUERIDAS
================================================================================

# Stripe Mexico
STRIPE_MX_SECRET_KEY=sk_live_xxx
STRIPE_MX_PUBLISHABLE_KEY=pk_live_xxx
STRIPE_MX_WEBHOOK_SECRET=whsec_xxx

# PAC para CFDI (Facturama ejemplo)
FACTURAMA_USER=xxx
FACTURAMA_PASSWORD=xxx
FACTURAMA_SANDBOX=false

# O SW Sapien
SW_USER=xxx
SW_PASSWORD=xxx
SW_URL=https://services.sw.com.mx

# Tasas de cambio
FX_API_KEY=xxx
FX_API_URL=https://api.exchangerate-api.com

# Configuracion Mexico
DEFAULT_COUNTRY_MX=MX
DEFAULT_CURRENCY_MX=MXN
DEFAULT_TAX_RATE_MX=0.16
ISR_RATE_WITH_RFC=0.025
ISR_RATE_WITHOUT_RFC=0.20
IVA_RETENTION_RATE=0.08

================================================================================
PARTE 6: CHECKLIST FINAL
================================================================================

ANTES DE LANZAR EN MEXICO, VERIFICAR:

[ ] Migraciones SQL aplicadas
[ ] Edge functions desplegadas
[ ] Variables de entorno configuradas
[ ] Integracion PAC funcionando (CFDI)
[ ] Stripe Mexico configurado
[ ] Zonas y tarifas configuradas
[ ] Documentos MX en app driver
[ ] Facturacion en app rider
[ ] Admin puede verificar documentos
[ ] Admin puede ver retenciones
[ ] Reportes SAT generandose
[ ] Locale es-MX completo
[ ] Validacion telefono +52
[ ] Testing en produccion con datos reales

================================================================================
FUENTES CONSULTADAS
================================================================================

Regulacion:
- https://todotaxi.org/decreto-de-regulacion-de-uber-didi-y-cabify-en-cdmx/
- https://www.nmas.com.mx/ciudad-de-mexico/congreso-cdmx-aprueba-regulacion-conductores-aplicacion-deban-certificarse-periodicamente-operar/
- https://alternativo.mx/regimen-plataformas-digitales-mexico-2026-guia-completa/

Licencias y documentos:
- https://floty.mx/blog/didi-conductor-mexico-requisitos/
- https://www.autofact.com.mx/blog/mi-carro/conduccion/licencia-e1
- https://www.rastreator.mx/seguro-ert/licencia-de-conducir-para-uber-didi-cabify-beat

Seguros:
- https://ahorraseguros.mx/seguros-de-autos/guias/seguro-de-auto-para-plataformas/
- https://www.rastreator.mx/seguros-de-uber-didi-cabify-beat

Fiscal:
- https://contadoresmismolenguaje.mx/inicio/blog/retencion-iva-isr-plataformas
- https://blog.gigstack.pro/post/uber-didi-2026-guia-retenciones-sat-conductores-mexico
- https://www.sat.gob.mx/minisitio/PlataformasTecnologicas/

CFDI:
- https://www.sat.gob.mx/aplicacion/75169/servicio-de-facturacion-cfdi-version-4.0
- https://xpd.mx/blog/catalogo-de-claves-usos-de-cfdi-4-0-consulta-en-linea.html

================================================================================
FIN DEL PLAN
================================================================================

NOTA PARA EL SIGUIENTE CLAUDE:
------------------------------
Este plan esta completo. Empieza por FASE 1 (migraciones SQL) y sigue en orden.
Los otros 2 archivos (PLAN_MX_COMPLETO.txt y ANALISIS_MX_3_APPS.txt) tienen
mas detalles tecnicos sobre los gaps en el codigo actual.

Si tienes dudas, pregunta al usuario. El sabe del proyecto.

================================================================================
