================================================================================
QU√â FALTA PARA CONTROL TOTAL DE M√âXICO EN ADMIN WEB
================================================================================
Fecha: 30 Enero 2026
An√°lisis basado en investigaci√≥n completa del admin web

================================================================================
ESTADO ACTUAL - QU√â YA EXISTE
================================================================================

‚úÖ BACKEND (Supabase):
   - 6 migrations aplicadas (004-009)
   - Tablas: countries, mexican_states, fx_rates, driver_documents_mx,
     tax_retentions, tax_monthly_summary, cfdi_invoices, pricing_zones_mx, etc.
   - 5 Edge Functions deployadas: pricing-quote-mx, fx-refresh,
     calculate-tax-retention, generate-cfdi, validate-driver-mx

‚úÖ DRIVER APP (toro_driver):
   - mexico_documents_screen.dart (driver sube sus documentos)
   - mexico_tax_screen.dart (driver ve sus retenciones)
   - mexico_invoices_screen.dart (driver solicita CFDIs)
   - 4 servicios: mexico_documents, mexico_tax, mexico_pricing, mexico_cfdi

‚úÖ ADMIN WEB (toro):
   - admin_mexico_pricing_screen.dart (zonas y reglas de pricing MX)
   - Ruta: /admin/mexico-pricing

‚úÖ RIDER APP (toro):
   - mexico_invoice_screen.dart (rider solicita facturas)
   - Ruta: /mexico-invoices


================================================================================
LO QUE FALTA - ADMIN WEB PARA CONTROL TOTAL MX
================================================================================

## 1. ADMIN MEXICO DOCUMENTS SCREEN ‚ö†Ô∏è CR√çTICO
--------------------------------------------------------------------------------
PROP√ìSITO: Ver y gestionar documentos de TODOS los drivers mexicanos

FUNCIONALIDAD NECESARIA:
- Lista de drivers mexicanos con status de documentos
- Filtros: estado de verificaci√≥n (pendiente, aprobado, rechazado, expirado)
- Filtros: tipo de documento (INE, RFC, Licencia E1, Tarjet√≥n, Seguro ERT)
- Vista detallada de documentos con im√°genes
- Acciones: Aprobar, Rechazar, Solicitar recarga
- KPIs:
  * Total drivers MX
  * Documentos pendientes de verificaci√≥n
  * Documentos por expirar (pr√≥ximos 30 d√≠as)
  * Documentos expirados
  * Tasa de aprobaci√≥n
- Alertas de documentos cr√≠ticos
- Export CSV de status de documentos
- B√∫squeda por driver name, email, RFC

INTEGRACI√ìN:
- Tabla: driver_documents_mx
- Edge Function: validate-driver-mx

RUTA SUGERIDA: /admin/mexico/documents


## 2. ADMIN MEXICO TAX SCREEN ‚ö†Ô∏è CR√çTICO
--------------------------------------------------------------------------------
PROP√ìSITO: Ver y gestionar retenciones de impuestos ISR/IVA de drivers MX

FUNCIONALIDAD NECESARIA:
- Lista de retenciones por driver
- Filtros: periodo (mes/a√±o), driver, estado (calculado, pagado, pendiente)
- KPIs:
  * Total retenciones ISR este mes
  * Total retenciones IVA este mes
  * Drivers con RFC (tasa 2.5%)
  * Drivers sin RFC (tasa 20%)
  * Total a pagar a SAT
- Vista mensual consolidada
- Vista por driver individual
- Descargar constancias de retenci√≥n (PDF)
- Export para contabilidad
- Gr√°ficas de tendencias de retenciones
- Calculadora de retenciones (preview)

INTEGRACI√ìN:
- Tabla: tax_retentions, tax_monthly_summary
- Edge Function: calculate-tax-retention

RUTA SUGERIDA: /admin/mexico/tax


## 3. ADMIN MEXICO CFDI SCREEN ‚ö†Ô∏è CR√çTICO
--------------------------------------------------------------------------------
PROP√ìSITO: Gestionar TODAS las facturas CFDI (riders y drivers)

FUNCIONALIDAD NECESARIA:
- Lista de CFDIs generadas
- Filtros: status (pending, issued, cancelled), tipo (ingreso, egreso),
  usuario (rider/driver), fecha, monto
- KPIs:
  * CFDIs emitidas hoy/mes
  * Total facturado
  * CFDIs pendientes
  * CFDIs canceladas
  * Tasa de √©xito con PAC
- Acciones:
  * Ver XML/PDF
  * Cancelar CFDI
  * Regenerar CFDI fallida
  * Enviar por email
- B√∫squeda por UUID, RFC, rider/driver
- Export para contabilidad
- Configuraci√≥n de PAC (Facturama/SW Sapien credentials)
- Monitor de errores de PAC
- Estad√≠sticas de uso de PAC

INTEGRACI√ìN:
- Tabla: cfdi_invoices, cfdi_platform_config
- Edge Function: generate-cfdi

RUTA SUGERIDA: /admin/mexico/cfdi


## 4. ADMIN MEXICO COMPLIANCE SCREEN üî∂ ALTA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Monitorear cumplimiento legal M√©xico (similar al USA compliance)

FUNCIONALIDAD NECESARIA:
- Status de licencias TNC por estado mexicano
- Documentos de plataforma (permisos SEMOVI, etc.)
- Requisitos por estado (CDMX, Guadalajara, Monterrey, etc.)
- KPIs:
  * Estados con operaci√≥n activa
  * Licencias por expirar
  * Drivers conformes vs no conformes por estado
  * Alertas regulatorias
- Calendar events para renovaciones
- Audit logs de acciones de compliance

INTEGRACI√ìN:
- Tabla: mexican_states, driver_documents_mx
- Reutiliza l√≥gica de admin_compliance_screen.dart

RUTA SUGERIDA: /admin/mexico/compliance


## 5. ADMIN MEXICO ANALYTICS SCREEN üî∂ ALTA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Analytics espec√≠ficos de operaci√≥n M√©xico

FUNCIONALIDAD NECESARIA:
- Dashboard de KPIs M√©xico:
  * Trips completados MX
  * Revenue MX (en MXN y USD)
  * Drivers activos MX
  * Riders activos MX
  * FX rate actual
  * Promedio de viaje MX
- Gr√°ficas:
  * Tendencia de viajes por estado
  * Revenue por ciudad (CDMX, GDL, MTY)
  * Comparativa USA vs MX
  * Uso de m√©todos de pago (OXXO, SPEI, tarjeta)
- Mapa de calor de zonas de pricing
- Top rutas en M√©xico
- Horas pico M√©xico

INTEGRACI√ìN:
- Tabla: deliveries (con country filter), pricing_zones_mx
- Reutiliza l√≥gica de admin_analytics_screen.dart

RUTA SUGERIDA: /admin/mexico/analytics


## 6. ADMIN MEXICO DRIVERS TAB üî∑ MEDIA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Vista filtrada de drivers mexicanos en el admin de drivers

FUNCIONALIDAD NECESARIA:
- Tab adicional en DriversShell: "MEXICO DRIVERS"
- Filtro autom√°tico: country = 'MX'
- Columnas adicionales:
  * RFC
  * Estado mexicano
  * Status de documentos MX
  * Retenciones acumuladas
- Link r√°pido a Mexico Documents para cada driver
- Link r√°pido a Mexico Tax para cada driver

INTEGRACI√ìN:
- Modificar: admin_drivers_screen.dart
- Agregar tab: /admin/drivers/tab-4 (Mexico)

RUTA SUGERIDA: /admin/drivers/tab-4


## 7. FINANCE INTEGRATION - MEXICO TABS üî∑ MEDIA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Separar finanzas USA vs MX en paneles existentes

MODIFICACIONES NECESARIAS:

A) finance_overview_screen.dart:
   - Selector de pa√≠s (USA / MX / ALL)
   - KPIs separados por pa√≠s
   - Revenue en MXN para M√©xico
   - FX rate display

B) transactions_screen.dart:
   - Filtro adicional: Country (USA/MX)
   - Columna de moneda (USD/MXN)
   - Conversi√≥n autom√°tica a display currency
   - Identificaci√≥n de transacciones OXXO/SPEI

C) driver_payouts_screen.dart:
   - Separar payouts USA vs MX
   - Para MX: mostrar retenciones ISR/IVA
   - Link a Mexico Tax screen

INTEGRACI√ìN:
- Modificar: finance/screens/*.dart
- Agregar: country filter en todos los queries


## 8. CALENDAR INTEGRATION - MEXICO EVENTS üî∑ MEDIA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Mostrar eventos fiscales de M√©xico en el calendario

MODIFICACIONES NECESARIAS:
- admin_calendar_screen.dart:
  * Agregar eventos de retenciones mensuales
  * Agregar eventos de declaraciones SAT
  * Agregar vencimientos de documentos MX
  * Color coding: USA events (blue), MX events (green)

INTEGRACI√ìN:
- Tabla: tax_monthly_summary (para fechas de retenciones)
- Tabla: driver_documents_mx (para expiraci√≥n de docs)


## 9. MAP INTEGRATION - MEXICO DRIVERS/RIDERS üü¢ BAJA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Distinguir drivers/riders de M√©xico en el mapa

MODIFICACIONES NECESARIAS:
- admin_map_screen.dart:
  * Marcadores diferentes para MX (bandera üá≤üáΩ)
  * Filtro: USA only / MX only / Both
  * Info popup: mostrar pa√≠s y estado

INTEGRACI√ìN:
- Modificar: admin_map_screen.dart


## 10. SETTINGS - MEXICO CONFIGURATION üü¢ BAJA PRIORIDAD
--------------------------------------------------------------------------------
PROP√ìSITO: Configuraci√≥n global para operaci√≥n M√©xico

FUNCIONALIDAD NECESARIA:
- PAC credentials (Facturama/SW Sapien)
- RFC de la plataforma
- Raz√≥n social
- Domicilio fiscal
- Logo para CFDIs
- API keys de servicios mexicanos
- FX rate source configuration
- Tasas de retenci√≥n ISR/IVA (editables)

INTEGRACI√ìN:
- Tabla: app_settings, cfdi_platform_config

RUTA SUGERIDA: /admin/mexico/settings


================================================================================
INTEGRACI√ìN CON PANELES EXISTENTES (RESUMEN)
================================================================================

PANELES QUE NECESITAN ACTUALIZACI√ìN:

1. ‚úÖ /admin/executive
   - Agregar selector de pa√≠s (USA/MX/ALL) en top bar
   - KPIs separados o combinados seg√∫n selecci√≥n

2. ‚úÖ /admin/drivers (DriversShell)
   - Nuevo tab "MEXICO DRIVERS" (tab-4)
   - Filtros de documentos MX

3. ‚úÖ /admin/finances (FinanceShell)
   - Todos los tabs necesitan filtro de pa√≠s
   - Overview, Transactions, Payouts cr√≠ticos

4. ‚úÖ /admin/analytics
   - Nuevo tab "MEXICO" o filtro de pa√≠s

5. ‚úÖ /admin/calendar
   - Integrar eventos fiscales MX

6. ‚úÖ /admin/map
   - Distinguir MX vs USA drivers/riders

7. ‚úÖ /admin/support
   - Filtro de pa√≠s en tickets
   - Soporte en espa√±ol para MX


================================================================================
NUEVAS RUTAS NECESARIAS
================================================================================

/admin/mexico/documents       ‚Üí AdminMexicoDocumentsScreen
/admin/mexico/tax            ‚Üí AdminMexicoTaxScreen
/admin/mexico/cfdi           ‚Üí AdminMexicoCFDIScreen
/admin/mexico/compliance     ‚Üí AdminMexicoComplianceScreen
/admin/mexico/analytics      ‚Üí AdminMexicoAnalyticsScreen
/admin/mexico/settings       ‚Üí AdminMexicoSettingsScreen

/admin/mexico-pricing        ‚Üí ‚úÖ YA EXISTE (AdminMexicoPricingScreen)


================================================================================
SIDEBAR - NUEVA SECCI√ìN M√âXICO
================================================================================

Agregar en EnterpriseAdminShell (enterprise_admin_shell.dart):

M√âXICO
‚îú‚îÄ üìä Analytics
‚îú‚îÄ üíµ Pricing
‚îú‚îÄ üìÑ Documents
‚îú‚îÄ üí∞ Tax & Retentions
‚îú‚îÄ üßæ CFDI Invoices
‚îú‚îÄ ‚öñÔ∏è Compliance
‚îî‚îÄ ‚öôÔ∏è Settings


================================================================================
PRIORIZACI√ìN DE DESARROLLO
================================================================================

üî¥ FASE 1 - CR√çTICO (Control Monetario Total):
   1. Admin Mexico Tax Screen - Ver todas las retenciones
   2. Admin Mexico CFDI Screen - Gestionar todas las facturas
   3. Finance Integration - Separar USA/MX en finanzas
   ‚Üí RESULTADO: Control total de dinero MX

üü° FASE 2 - ALTA PRIORIDAD (Operaci√≥n Completa):
   4. Admin Mexico Documents Screen - Verificar documentos drivers
   5. Admin Mexico Analytics Screen - KPIs y dashboards MX
   6. Admin Mexico Compliance Screen - Cumplimiento legal
   ‚Üí RESULTADO: Operaci√≥n completa MX

üü¢ FASE 3 - MEDIA PRIORIDAD (Optimizaci√≥n):
   7. Mexico Drivers Tab - Vista dedicada drivers MX
   8. Calendar Integration - Eventos fiscales MX
   9. Map Integration - Distinguir MX drivers
   ‚Üí RESULTADO: Experiencia optimizada

üîµ FASE 4 - BAJA PRIORIDAD (Nice to Have):
   10. Mexico Settings Screen - Configuraci√≥n avanzada
   ‚Üí RESULTADO: Personalizaci√≥n completa


================================================================================
ESTIMACI√ìN DE ARCHIVOS A CREAR
================================================================================

NUEVOS ARCHIVOS (6 screens principales + repos/services):

1. lib/features/admin/mexico/admin_mexico_documents_screen.dart
2. lib/features/admin/mexico/admin_mexico_tax_screen.dart
3. lib/features/admin/mexico/admin_mexico_cfdi_screen.dart
4. lib/features/admin/mexico/admin_mexico_compliance_screen.dart
5. lib/features/admin/mexico/admin_mexico_analytics_screen.dart
6. lib/features/admin/mexico/admin_mexico_settings_screen.dart

7. lib/features/admin/mexico/mexico_documents_repo.dart
8. lib/features/admin/mexico/mexico_tax_repo.dart
9. lib/features/admin/mexico/mexico_cfdi_repo.dart

ARCHIVOS A MODIFICAR (integraci√≥n):

10. lib/core/router/app_router.dart (agregar rutas)
11. lib/features/admin/enterprise/enterprise_admin_shell.dart (sidebar)
12. lib/features/admin/admin_drivers_screen.dart (agregar tab MX)
13. lib/features/admin/finance/screens/finance_overview_screen.dart
14. lib/features/admin/finance/screens/transactions_screen.dart
15. lib/features/admin/finance/screens/driver_payouts_screen.dart
16. lib/features/admin/admin_calendar_screen.dart
17. lib/features/admin/admin_map_screen.dart
18. lib/features/admin/admin_executive_dashboard_screen.dart


================================================================================
DEPENDENCIAS DE DATOS (YA EXISTEN EN SUPABASE)
================================================================================

‚úÖ driver_documents_mx - Documentos de drivers MX
‚úÖ tax_retentions - Retenciones ISR/IVA
‚úÖ tax_monthly_summary - Res√∫menes mensuales de impuestos
‚úÖ cfdi_invoices - Facturas CFDI generadas
‚úÖ cfdi_platform_config - Configuraci√≥n del PAC
‚úÖ pricing_zones_mx - Zonas de pricing MX
‚úÖ pricing_rules_mx - Reglas de pricing MX
‚úÖ fx_rates - Tasas de cambio
‚úÖ mexican_states - Estados mexicanos
‚úÖ countries - Pa√≠ses (USA, MX)


================================================================================
RESPUESTA A LA PREGUNTA DEL USUARIO
================================================================================

Para tener CONTROL TOTAL MONETARIO de M√©xico necesitas:

üî¥ M√çNIMO INDISPENSABLE (Control Monetario):
   1. Admin Mexico Tax Screen - Ver retenciones ISR/IVA de todos los drivers
   2. Admin Mexico CFDI Screen - Gestionar facturas de riders y drivers
   3. Finance tabs actualizados - Filtrar por pa√≠s USA/MX

üü° RECOMENDADO (Operaci√≥n Completa):
   + Admin Mexico Documents Screen - Verificar que drivers tengan docs v√°lidos
   + Admin Mexico Analytics - Dashboard con KPIs de M√©xico
   + Admin Mexico Compliance - Cumplimiento legal por estado

üü¢ IDEAL (Experiencia Completa):
   + Todo lo anterior
   + Integration en Calendar, Map, Drivers tabs
   + Mexico Settings para configuraci√≥n PAC


================================================================================
PR√ìXIMOS PASOS SUGERIDOS
================================================================================

OPCI√ìN A - Crear TODO de una vez (6 screens + modificaciones)
   Pros: Completar MX 100%
   Contras: Mucho c√≥digo, m√∫ltiples sesiones

OPCI√ìN B - Empezar con lo cr√≠tico (Fase 1)
   Crear: Admin Mexico Tax + Admin Mexico CFDI + Finance Integration
   Pros: Control monetario inmediato
   Contras: Falta operaci√≥n completa

OPCI√ìN C - Uno por uno (empezar con Tax Screen)
   Crear: Solo Admin Mexico Tax Screen
   Pros: Probar enfoque, menos riesgo
   Contras: Toma m√°s sesiones llegar a 100%


================================================================================
FIN DEL AN√ÅLISIS
================================================================================
